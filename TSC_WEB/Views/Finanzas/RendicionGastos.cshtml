@{
    ViewBag.Title = "Rendición de Gastos con Solicitud";
    ViewBag.Modulo = "Finanzas";
    Layout = "~/Views/Plantillas/_Layout.cshtml";
}


<div class="rendgas container-fluid">

    <div class="container-fluid card">

        <div class=" mt-3 ml-2 d-flex flex-row justify-content-between">
            <div>
                <button type="button" id="zbtnBuscarPendiente" class="btn btn-warning btn-sm">Buscar Pendientes</button>
            </div>
            <div class="zindicador">
                <div class="row d-flex flex-row">
                    <div id="zestado-icon"></div>
                    <h5 id="zestado-desc"></h5>
                </div>
            </div>
        </div>

        <hr />

        <div class="row m-1">

            <div class="col-1 p-1">
                <label for="ztxtCodigo">Código:</label>
                <input class="form-control form-control-sm" id="ztxtCodigo" disabled>
            </div>
            <div class="col-1 p-1">
                <label for="ztxtFecha">Fecha</label>
                <input class="form-control form-control-sm" type="text" id="ztxtFecha" disabled>
            </div>
            <div class="col-3 p-1">
                <label for="ztxtUsuario">Usuario:</label>
                <input class="form-control form-control-sm" id="ztxtUsuario" disabled>
            </div>
            <div class="col-2 p-1">
                <label for="ztxtTipo">Tipo:</label>
                <input class="form-control form-control-sm" id="ztxtTipo" disabled>
            </div>
            <div class="col-5 p-1">
                <label for="ztxtCeCo">Centro de Costo:</label>
                <input class="form-control form-control-sm" id="ztxtCeCo" disabled>
            </div>


            <div class="col-5 p-1">
                <label for="ztxtColaborador">Colaborador</label>
                <input class="form-control form-control-sm" type="text" id="ztxtColaborador" disabled>
            </div>
            <div class="col-5 p-1">
                <label for="ztxtGlosa">Glosa Solicitud</label>
                <input class="form-control form-control-sm" type="text" id="ztxtGlosa" disabled>
            </div>

            <div class="col-2 p-1">
                <label for="ztxtTotalSol">Total:</label>
                <input class="form-control form-control-sm" type="text" id="ztxtTotalSol" disabled>
            </div>
        </div>


        <div>
            <hr />
        </div>

        <div class="container-fluid mt-2">
            <table class="table table-sm table-bordered table-hover display nowrap" id="ztblSolicitud">
                <thead class="thead-light">
                    <tr>
                        <th class="ocultar-columna">idSolicitud</th>
                        <th class="ocultar-columna">Secuencia</th>
                        <th>Serie Número</th>
                        <th>Tipo</th>
                        <th>Concepto</th>
                        <th>Detallle</th>

                        <th>Cant. Dias</th>
                        <th>Valor Unitario</th>
                        <th>Total Solicitado</th>
                        <th>Total Entregado</th>
                        <th>Total Rendido</th>
                        <th>Exceso / Devolución</th>

                        @*<th style="text-align: center">Eliminar cpte</th>*@
                        @*<th style="text-align: center">EDITAR</th>*@
                        @*<th style="text-align: center">PDF</th>*@
                        <th style="text-align: center">REGISTRO</th>

                    </tr>
                </thead>
                <tbody id="ztblSolicitudContent"></tbody>
            </table>
        </div>

        <div>
            <hr />
        </div>

        <div class="container-fluid mb-2">
            <div class="row d-flex justify-content-lg-between">
                @*<div>*@
                <button type="button" id="zbtnVerRegistrados" class="btn btn-primary btn-sm"><i class='fas fa-eye'></i>  Ver Registrados</button>
                @*</div>
                    <div>
                        <button type="button" id="zbtnRegistrarcomprobante" class="btn btn-success btn-sm"><i class='fas fa-save'></i>  Registrar Comprobante</button>
                    </div>*@
            </div>
        </div>


    </div>

    <div class="modal fade" id="zproveedorModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Registro de zproveedor</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>

                        <div class="form-group">
                            <div class="row">
                                <div class="col-6">
                                    <label for="ztxtTipoPersonaModal">Tipo Persona</label>
                                    <select class="form-control form-control-sm" id="ztxtTipoPersonaModal" disabled>
                                        <option value="J" selected>Jurídica</option>
                                    </select>
                                </div>

                                <div class="col-6">
                                    <label for="ztxtPaisModal">Pais:</label>
                                    <input type="text" class="form-control form-control-sm" id="ztxtPaisModal" value="Perú" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="ztxtRUCModal" class="col-form-label">RUC:</label>
                            <input type="text" class="form-control" id="ztxtRUCModal" maxlength="15">
                        </div>

                        <div class="form-group">
                            <label for="ztxtRSModal" class="col-form-label">Razon Social:</label>
                            <input type="text" class="form-control" id="ztxtRSModal" maxlength="140">
                        </div>

                        <div class="form-group">
                            <label for="ztxtDireccionModal" class="col-form-label">Dirección:</label>
                            <textarea class="form-control" id="ztxtDireccionModal" maxlength="340"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="zbtnRegistrarzproveedor">Registrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="zmodalSolicitudesPendientes" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Solicitudes Pendientes de Rendición</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="contenedor-detalle">
                        <table class="table table-sm table-bordered table-hover display nowrap" id="ztblDetallePendiente" style="width: 100%">
                            <thead class="thead-light">
                                <tr>
                                    <th class="ocultar-columna">IdSolicitud</th>
                                    <th>Fecha</th>
                                    <th>Codigo</th>
                                    <th>Glosa</th>
                                    <th>Total</th>
                                    <th style="text-align: center">Seleccionar</th>
                                </tr>
                            </thead>
                            <tbody id="ztblDetallePendienteContent"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" data-dismiss="modal" class="btn btn-primary">OK</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="zregComprobModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Registro de Comprobante</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <ul class="nav nav-tabs nav-justified md-tabs indigo" id="ztabRendicionGastos" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active zctabRegComp" data-id="1" id="zfacturaboleta-tab" data-toggle="tab" href="#zsg-facturaboleta" role="tab" aria-controls="firma-just"
                               aria-selected="true">Factura / Boleta</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link zctabRegComp" data-id="2" id="zplanillamovilidad-tab" data-toggle="tab" href="#zsg-planillamovilidad" role="tab" aria-controls="aprobadas-just"
                               aria-selected="false">Planilla de Movilidad</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link zctabRegComp" data-id="3" id="zdeclaracionjur-tab" data-toggle="tab" href="#zsg-declaracionjur" role="tab" aria-controls="aprobadas-just"
                               aria-selected="false">Declaración Jurada</a>
                        </li>
                    </ul>

                    <div class="tab-content card pt-1">

                        <div class="tab-pane fade show active" id="zsg-facturaboleta" role="tabpanel" aria-labelledby="zfacturaboleta-tab">
                            @Html.Partial("Finanzas/rendRendFacturaBoleta")
                        </div>
                        <div class="tab-pane fade" id="zsg-planillamovilidad" role="tabpanel" aria-labelledby="zplanillamovilidad-tab">
                            @Html.Partial("Finanzas/rendRendPlanillaMovilidad")
                        </div>
                        <div class="tab-pane fade" id="zsg-declaracionjur" role="tabpanel" aria-labelledby="zdeclaracionjur-tab">
                            @Html.Partial("Finanzas/rendRendDeclaracionJurada")
                        </div>

                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-sm btn-primary" id="zbtnGuardarComprobante">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="zregistrarDevModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Monto Devolución</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-12">
                                <input type="email" class="form-control" id="ztxtMontoDevolucion" placeholder="Ingrese monto de devolución">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-sm btn-primary" id="zbtnGuardarDevolucion">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="zdetComprobantesModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Comprobante Registrados</h5>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">

                        <table class="table table-sm table-bordered" id="ztblCptesRegistrados" style="width: 100%">
                            <thead class="thead-light">
                                <tr>
                                    <th>Serie Numero</th>
                                    <th>zproveedor</th>
                                    <th>Total</th>
                                    <th>Impresión</th>
                                    <th>Editar</th>
                                    <th>Eliminar</th>
                                </tr>
                            </thead>
                            <tbody id="ztblCptesRegistradosCont"></tbody>
                        </table>

                    </div>
                </div>
            </div>
        </div>
    </div>

</div>


<style>


    .rendgas label {
        font-family: 'Roboto', sans-serif;
    }

    .rendgas input, select, span, label {
        font-family: 'Roboto', sans-serif;
    }

    table th.ocultar-columna {
        display: none !important;
    }

    table tr.ocultar-columna {
        display: none !important;
    }

    table td.ocultar-columna {
        display: none !important;
    }

    .rendgas #zestado-desc {
        margin-right: 8px;
    }

    #zregComprobModal .kpi-modal-monto1 {
        text-align: center;
        background-color: #D5D8DC;
    }

    #zregComprobModal .kpi-modal-monto2 {
        text-align: center;
        background-color: #D5D8DC;
    }

    #zregComprobModal .kpi-modal-monto3 {
        text-align: center;
        background-color: #D5D8DC;
    }



    a.disabled {
        pointer-events: none;
        color: #ccc;
    }


    #editComprobModal .kpi-modal-monto1 {
        text-align: center;
        background-color: #D5D8DC;
    }

    #editComprobModal .kpi-modal-monto2 {
        text-align: center;
        background-color: #D5D8DC;
    }

    #editComprobModal .kpi-modal-monto3 {
        text-align: center;
        background-color: #D5D8DC;
    }

    #editComprobModal #zlist-comprobantes {
        background-color: #F2F4F4
    }


    #editComprobModal #btnImprimirPDF {
        background-color: #AF1204;
        color: #fff;
    }


    .rendgas .icon-pendiente::after {
        content: url(../../../../Public/icon-pend.png);
    }

    .rendgas .icon-liberado::after {
        content: url(../../../../Public/icon-libe.png);
    }

    .rendgas .icon-aprobado::after {
        content: url(../../../../Public/icon-apro.png);
    }

    .rendgas .icon-rechazado::after {
        content: url(../../../../Public/icon-rech.png);
    }

    .rendgas .icon-rend-completa::after {
        content: url(../../../../Public/icon-apro.png);
    }

    .rendgas .icon-rend-incompleta::after {
        content: url(../../../../Public/icon-libe.png);
    }



    .rendgas .desc-est-pendiente {
        color: #616A6B;
    }

    .rendgas .desc-est-liberado {
        color: #F1C40F;
    }

    .rendgas .desc-est-aprobado {
        color: #28B463;
    }

    .rendgas .desc-est-rechazado {
        color: #C0392B;
    }

    .rendgas .desc-est-rend-completa {
        color: #28B463;
    }

    .rendgas .desc-est-rend-incompleta {
        color: #F1C40F;
    }


    @@media (min-width: 320px) and (max-width: 479.98px) {
    }

    @@media (min-width: 480px) and (max-width: 767.98px) {
    }

    @@media (min-width: 768px) and (max-width: 991.98px) {
    }

    @@media (min-width: 992px) and (max-width: 1199.98px) {
    }

    @@media (min-width: 1200px) {
    }
</style>


@section scripts {
    <script>

        const USUARIO = "@Request.RequestContext.HttpContext.Session["usuario"]";
        const USUARIO_COMPLETO = "@Request.RequestContext.HttpContext.Session["usuario"]" + " - " + "@Request.RequestContext.HttpContext.Session["nombre"]";
        const PORCENTAJE_IGV = 18;


        var zvTipoComprobante1 = [];

        var zsolicitudSeleccionada = {};
        var zvIdSolicitud = 0;
        var zvCeCo = 0;
        var zvIdRendCompte = 0;

        var ziDetalle1 = 0;
        var ziDetalle2 = 0;
        var ziDetalle3 = 0;

        var zproveedor = {};
        var zdetalleArray = [];
        var zdetalleArray3 = [];
        var zdetPlaMov = {};

        var zdetComprobanteArray1 = [];
        var zdetComprobanteArray2 = [];
        var zdetComprobanteArray3 = [];

        var ztabSeleccionado = 1; // 1: Factura y Boleta, 2: Planilla Movilidad, 3: Planilla de Movilidada

        var zlistaComptesIdTipoComp = 0;

        var zidsolicitud_dev = 0;
        var zidsecuencia_dev = 0;

        var zTIPO_REGISTRO = "";
        var ztiposComprobantesArray = [];

        $(document).ready(function () {

            Inicializar();

            function Inicializar() {

                zgetTipoComprobantes();
                zgetTipoMoneda();
                zgetUnidadesMedida();
                zgetPeriodos();

                $("#zregComprobModal .kpi-modal-monto1").css("background-color", "#ABB2B9");
                $("#zregComprobModal .kpi-modal-monto2").css("background-color", "#ABB2B9");
                $("#zregComprobModal .kpi-modal-monto3").css("background-color", "#ABB2B9");

                $("#ztxtCodigoModal3").val("0");
                $("#ztxtNumPlanillaModal2").val("0");

            }


            function zsetPeriodo() {

                let fechaFormato = new Date();

                let month = '' + (fechaFormato.getMonth() + 1);
                let year = fechaFormato.getFullYear();

                if (month.length < 2) { month = '0' + month; }

                $("#zcbxPeriodoModal1").val("" + [year, month].join('-'));
                $("#zcbxPeriodoModal2").val("" + [year, month].join('-'));
                $("#zcbxPeriodoModal3").val("" + [year, month].join('-'));

                document.getElementById("zcbxPeriodoModal1").disabled = true;
                document.getElementById("zcbxPeriodoModal2").disabled = true;
                document.getElementById("zcbxPeriodoModal3").disabled = true;
            }

            function zgetTipoMoneda() {
                $.ajax({
                    type: "GET",
                    url: '/Finanzas/RG_TiposDeMoneda',
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {
                        $("#zcbxMonedaModal1").empty();
                        $("#zcbxMonedaModal2").empty();
                        $("#zcbxMonedaModal3").empty();

                        $.each(data.lista, function () {
                            $("#zcbxMonedaModal1").append($("<option/>").val(this.idTipoMod).text(this.descripcion));
                            $("#zcbxMonedaModal2").append($("<option/>").val(this.idTipoMod).text(this.descripcion));
                            $("#zcbxMonedaModal3").append($("<option/>").val(this.idTipoMod).text(this.descripcion));
                        });

                        $("#zcbxMonedaModal1").val(1);
                        $("#zcbxMonedaModal2").val(1);
                        $("#zcbxMonedaModal3").val(1);

                    },
                    failure: function () {
                        console.error('error al cargar tipos periodos');
                    }
                });
            }

            function zgetPeriodos() {

                $.ajax({
                    type: "GET",
                    url: '/Finanzas/RG_Periodos',
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {

                        $("#zcbxPeriodoModal1").empty();
                        $("#zcbxPeriodoModal2").empty();
                        $("#zcbxPeriodoModal3").empty();

                        $.each(data.lista, function () {
                            $("#zcbxPeriodoModal1").append($("<option/>").val(this.periodo).text(this.periodo));
                            $("#zcbxPeriodoModal2").append($("<option/>").val(this.periodo).text(this.periodo));
                            $("#zcbxPeriodoModal3").append($("<option/>").val(this.periodo).text(this.periodo));
                        });

                        zsetPeriodo();
                    },
                    failure: function () {
                        console.error('error al cargar tipos periodos');
                    }
                });
            }

            function zgetUnidadesMedida() {

                $.ajax({
                    type: "GET",
                    url: '/Finanzas/RG_UnidadesMedida',
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {
                        $("#zcbxUM1").empty();

                        $.each(data.lista, function () {
                            $("#zcbxUM1").append($("<option/>").val(this.codum).text(this.um));
                        });

                        $("#zcbxUM1").val("UN");
                    },
                    failure: function () {
                        console.error('error al cargar tipos periodos');
                    }
                });

            }

            function zgetTipoComprobantes() {
                $.ajax({
                    type: "GET",
                    url: '/Finanzas/RG_TipoComprobantes',
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {
                        let primerValorBool = true;

                        ztiposComprobantesArray = data.lista;

                        $("#zcbxTipoCpbteCompModal1").empty();
                        $("#zcbxTipoCpbteCompModal2").empty();
                        $("#zcbxTipoCpbteCompModal3").empty();


                        $.each(data.lista, function () {
                            if (primerValorBool) {
                                vCodTipoComprobante = this.idTipoComp;
                            }

                            if (this.idTipoComp == 1 || this.idTipoComp == 2) {
                                $("#zcbxTipoCpbteCompModal1").append($("<option/>").val(this.idTipoComp).text(this.tipoComprobante));
                            }
                            else if (this.idTipoComp == 3) {
                                $("#zcbxTipoCpbteCompModal2").append($("<option/>").val(this.idTipoComp).text(this.tipoComprobante));
                            }
                            else if (this.idTipoComp == 4) {
                                $("#zcbxTipoCpbteCompModal3").append($("<option/>").val(this.idTipoComp).text(this.tipoComprobante));
                            }

                            primerValorBool = false;
                        });

                        zcambioTipoCpte(vCodTipoComprobante);

                        $("#zcbxTipoCpbteCompModal1").val(vCodTipoComprobante); // Factura o boleta.
                        $("#zcbxTipoCpbteCompModal2").val(3); // Planilla de Movilidad
                        $("#zcbxTipoCpbteCompModal3").val(4); // Planilla de Movilidad

                        document.getElementById("zcbxTipoCpbteCompModal2").disabled = true;
                        document.getElementById("zcbxTipoCpbteCompModal3").disabled = true;
                    },
                    failure: function () {
                        console.error('error al cargar tipos periodos');
                    }
                });
            }

            function zcambioTipoCpte(pCodTipoCpte) {

                // Limpiar TAB Factura Boleta

                if (pCodTipoCpte == 1) {
                    // Factura
                    document.getElementById("zcbxTipoCpbteCompModal1").disabled = false;
                    document.getElementById("ztxtSerieModal1").disabled = false;
                    document.getElementById("ztxtNumeroModal1").disabled = false;
                    document.getElementById("ztxtObsCompModal1").disabled = false;

                    document.getElementById("zcbxUM1").disabled = false;
                    document.getElementById("ztxtDescripcion1").disabled = false;
                    //document.getElementById("ztxtCantidad1").disabled = false;
                    document.getElementById("ztxtValorUnitarioTotal1").disabled = false;

                    document.getElementById("zidimportetotal1").disabled = true;
                    document.getElementById("zidigv1").disabled = true;
                    document.getElementById("zidtotal1").disabled = true;

                    document.getElementById("ztxtSerieModal1").focus = true;
                }
                else if (pCodTipoCpte == 2) {
                    // Boleta
                    document.getElementById("zcbxTipoCpbteCompModal1").disabled = false;
                    document.getElementById("ztxtSerieModal1").disabled = false;
                    document.getElementById("ztxtObsCompModal1").disabled = false;

                    document.getElementById("zcbxUM1").disabled = true;
                    document.getElementById("ztxtDescripcion1").disabled = false;
                    //document.getElementById("ztxtCantidad1").disabled = true;
                    document.getElementById("ztxtValorUnitarioTotal1").disabled = false;

                    $("#ztxtDescripcion1").val("");
                    $("#zcbxUM1").val("UN");
                    //$("#ztxtCantidad1").val(1);

                    document.getElementById("ztxtValorUnitarioTotal1").focus = true;

                }

                zdetComprobanteArray1 = [];

                let tabla = $("#ztblFacturaBoleta").DataTable();
                tabla.destroy();
                var tr = "";
                $("#ztblFacturaBoletaContent").html(tr);
                $("#ztblFacturaBoleta").DataTable(
                    {
                        'language': { 'url': '/libs/datatables/spanish.json' },
                        lengthMenu: [[3], [3]]
                    }
                );

                document.getElementById("zidimportetotal1").disabled = true;
                document.getElementById("zidigv1").disabled = true;
                document.getElementById("zidtotal1").disabled = true;

                $("#zidimportetotal1").val("0");
                $("#zidigv1").val("0");
                $("#zidtotal1").val("0");
            }

            function zvalidacionRegistro() {
                var respuesta = false;

                if ($("#ztxtRUCModal").val().trim() == "") {
                    respuesta = false;
                    Swal.fire({
                        title: 'Ingrese un código de RUC',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'

                    });
                }
                else if ($("#ztxtRSModal").val().trim() == "") {
                    respuesta = false;

                    Swal.fire({
                        title: 'Ingrese Razon Social',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else {
                    respuesta = true;
                }

                return respuesta;
            }

            $('#ztxtRucCompModal1').keypress(function (event) {
                var keycode = (event.keyCode ? event.keyCode : event.which);

                if (keycode == '13') {

                    let ruc = $("#ztxtRucCompModal1").val().trim();

                    if (ruc == "") {
                        Swal.fire({
                            title: 'Ingrese RUC',
                            text: "Textile Sourcing Company",
                            icon: 'warning',
                            showConfirmButton: true,
                            showCancelButton: false,
                            confirmButtonText: 'Ok',
                            cancelButtonText: 'Cancel',
                            focusConfirm: true
                        }).then(result => {
                            if (result.value) {
                                document.getElementById("ztxtRucCompModal1").focus = true;
                            }
                        });
                    }
                    else if (ruc.length < 7 || ruc.length > 15) {
                        Swal.fire({
                            title: 'Ingrese un número RUC valido por favor',
                            icon: 'warning',
                            showConfirmButton: true,
                            showCancelButton: false,
                            confirmButtonText: 'Ok',
                            cancelButtonText: 'Cancel',
                            focusConfirm: true
                        }).then(result => {
                            if (result.value) {
                                //document.getElementById("idztxtCodigo").focus = true;
                            }
                        });
                    }
                    else {

                        MostrarCarga("Buscando...");


                        $.ajax({
                            url: "/finanzas/RG_SetproveedorValidar",
                            type: "POST",
                            data: { 'opcion': '1', 'tipoPersona': 'J', 'ruc': ruc, 'rs': '', 'direccion': '' },
                            dataType: "json",
                            success: function (resultado) {

                                if (resultado.isRedirect) {
                                    window.location.href = resultado.redirectUrl;
                                }
                                else {
                                    zproveedor = resultado.entidad;

                                    if (resultado.entidad.idResponse == 0) {

                                        Swal.fire({
                                            title: '¿zproveedor no existe, desea crearlo?',
                                            text: "Textile Sourcing Company",
                                            icon: 'warning',
                                            showCancelButton: true,
                                            confirmButtonColor: '#3085d6',
                                            cancelButtonColor: '#d33',
                                            confirmButtonText: 'Si',
                                            cancelButtonText: 'No'
                                        }).then((result) => {
                                            if (result.value) {
                                                $("#zregComprobModal").modal("hide");
                                                $('#zproveedorModal').modal('show');
                                            }
                                        });
                                    }
                                    else {

                                        $("#ztxtRSCompModal1").val(resultado.entidad.danvar);
                                        $("#ztxtCodSofyaPCModal1").val(resultado.entidad.ctpava + "-" + resultado.entidad.canvar);

                                        zmensajePrincipal(true, "proveedor correcto");
                                    }
                                }
                            },
                            error: function (xhr, ajaxOptions, thrownError) {

                            }
                        });

                    }

                }
            });

            $("#zbtnRegistrarzproveedor").click(function () {

                if (zvalidacionRegistro()) {

                    MostrarCarga("Guardando...");

                    $.ajax({
                        url: "/finanzas/RG_SetproveedorRegistrar",
                        type: "POST",
                        data: {
                            'opcion': '2',
                            'tipoPersona': 'J',
                            'ruc': $("#ztxtRUCModal").val(),
                            'rs': $("#ztxtRSModal").val(),
                            'direccion': $("#ztxtDireccionModal").val()
                        },
                        dataType: "json",
                        success: function (resultado) {

                            zproveedor = resultado.entidad;

                            if (resultado.isRedirect) {
                                window.location.href = resultado.redirectUrl;
                            }
                            else {

                                if (resultado.entidad.idResponse == 1) {
                                    zmensajePrincipal(true, resultado.entidad.statusResponse);
                                }
                                else {
                                    zmensajePrincipal(false, resultado.entidad.statusResponse);
                                }
                            }

                            $("#ztxtRucCompModal1").val(zproveedor.creguc);
                            $("#ztxtRSCompModal1").val(zproveedor.danvar);
                            $("#ztxtCodSofyaPCModal1").val(zproveedor.ctpava + "-" + zproveedor.canvar);

                            $('#zproveedorModal').modal('hide');
                            $("#zregComprobModal").modal("show");

                        },
                        error: function (xhr, ajaxOptions, thrownError) {

                        }
                    });
                }
            });

            $("#zbtnBuscarPendiente").click(function () {

                $.ajax({
                    type: "GET",
                    url: '/finanzas/RG_PendientesRendicion',
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {

                        let tabla = $("#ztblDetallePendiente").DataTable();

                        tabla.destroy();
                        var tr = "";

                        data.lista.forEach((obj) => {

                            tr += "<tr> "
                                + " <td class='ocultar-columna'> " + obj.idSolicitud + "</td>"
                                + " <td> " + obj.fecha + "</td>"
                                + " <td> " + obj.codigo + "</td>"
                                + " <td> " + obj.glosa + "</td>"
                                + " <td> " + obj.total + "</td>"
                                + " <td class='text-center'>"
                                + "     <button data-codigo='" + obj.codigo + "' data-idsolicitud='" + obj.idSolicitud + "' data-toggle='collapse' class='btn btn-sm btn-outline-secondary cseleccionar ml-1'><i class='fas fa-check'></i></button>"
                                + "</td>"
                                + "</tr>";
                        });

                        $("#ztblDetallePendienteContent").html(tr);


                        $("#ztblDetallePendiente").DataTable(
                            {
                                'language': { 'url': '/libs/datatables/spanish.json' },
                                lengthMenu: [[5, 10, 20, -1], [5, 10, 20, 'Todos']]
                            });

                    },
                    failure: function () {
                        console.error('error al cargar los periodos');
                    }
                });


                $('#zmodalSolicitudesPendientes').modal('show');

            });

            $("#ztblDetallePendiente").on('click', '.cseleccionar', function () {
                // Modal Detalle, selecciona la solicitud.

                let codigo = $(this).attr("data-codigo");
                let idsolicitud = $(this).attr("data-idsolicitud");

                $.ajax({
                    url: "/finanzas/RG_SolBusquedaXCod",
                    type: "GET",
                    data: { 'codigo': codigo, 'idSolicitud': idsolicitud },
                    dataType: "json",
                    success: function (resultado) {


                        if (resultado.isRedirect) {
                            window.location.href = resultado.redirectUrl;
                        }
                        else {
                            if (resultado.entidad.idSolicitud > 0) {

                                zsolicitudSeleccionada = resultado.entidad;

                                $("#ztxtFecha").val(resultado.entidad.fecha);
                                $("#ztxtUsuario").val(USUARIO_COMPLETO);
                                $("#ztxtTipo").val(resultado.entidad.tipo);
                                $("#ztxtGlosa").val(resultado.entidad.observacion);
                                $("#ztxtCeCo").val(resultado.entidad.ceco);
                                $("#ztxtCodigo").val(resultado.entidad.codigo);
                                $("#ztxtColaborador").val(resultado.entidad.colaborador);
                                $("#ztxtTotalSol").val(resultado.entidad.simbolo + " " + formatoNumero(resultado.entidad.total));

                                $("#zestado-desc").text(resultado.entidad.estado);

                                zmensajePrincipal(true, "Mostrando Solicitud");
                                zvalidarEstadoSolicitud(2, idsolicitud);

                                zarmarTablaDetalle(resultado.entidad.listaDetalle);
                                zindicadorEstado(resultado.entidad.idEstado);

                                $('#zmodalSolicitudesPendientes').modal('hide');
                            }
                            else {
                                zmensajePrincipal(false, "Solicitud no encontrada");
                            }
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {

                    }
                });
            });

            $("#ztblSolicitud").on('click', '.seleccion', function () {

                let idsolicitud = $(this).attr("data-idsolicitud");
                let secuencia = $(this).attr("data-secuencia");
                let valor = $(this).attr("data-valor");
                let totalRestante = $(this).attr("data-restante");

                if ($(this).prop("checked")) {

                    zdetalleArray.push({ idsolicitud: idsolicitud, secuencia: secuencia, valor: parseFloat(valor), totalrestante: parseFloat(totalRestante) });

                } else {

                    for (var i = 0; i < zdetalleArray.length; i++) {
                        if (zdetalleArray[i].idsolicitud == idsolicitud && zdetalleArray[i].secuencia == secuencia) {
                            zdetalleArray.splice(i, 1);
                        }
                    }
                }
            });

            $("#ztblSolicitudContent").on("click", ".cRegistrarCpte", function () {

                let idsolicitud = $(this).attr("data-idsolicitud");
                let secuencia = $(this).attr("data-secuencia");
                let valor = $(this).attr("data-valor");
                let totalRestante = $(this).attr("data-restante");
                let idconceptodet = $(this).attr("data-idconceptodet");

                zdetalleArray.push({ idsolicitud: idsolicitud, secuencia: secuencia, valor: parseFloat(valor), totalrestante: parseFloat(totalRestante) });

                let valorRestante = 0;

                zlimpiarControlModal(1);
                zlimpiarControlModal(2);
                zlimpiarControlModal(3);

                zTIPO_REGISTRO = "INSERTAR";

                $("#ztxtCeCoModal1").val(zsolicitudSeleccionada.ceco);
                $("#ztxtCeCoModal2").val(zsolicitudSeleccionada.ceco);
                $("#ztxtCeCoModal3").val(zsolicitudSeleccionada.ceco);

                $("#ztxtDNIModal2").val(zsolicitudSeleccionada.canvar_bnf);
                $("#ztxtDNIModal3").val(zsolicitudSeleccionada.canvar_bnf);
                $("#ztxtApeNomModal2").val(zsolicitudSeleccionada.colaborador);
                $("#ztxtApeNomModal3").val(zsolicitudSeleccionada.colaborador);

                for (var i = 0; i < zdetalleArray.length; i++) {
                    valorRestante = valorRestante + zdetalleArray[i].totalrestante;
                }

                $("#zkpiMontoSeleecionadoModal1").text(zsolicitudSeleccionada.simbolo + " " + formatoNumero(valorRestante));
                $("#zkpiMontoSeleecionadoModal2").text(zsolicitudSeleccionada.simbolo + " " + formatoNumero(valorRestante));
                $("#zkpiMontoSeleecionadoModal3").text(zsolicitudSeleccionada.simbolo + " " + formatoNumero(valorRestante));

                $("#zregComprobModal .kpi-modal-monto1").css("background-color", "#ABB2B9");
                $("#zregComprobModal .kpi-modal-monto2").css("background-color", "#ABB2B9");
                $("#zregComprobModal .kpi-modal-monto3").css("background-color", "#ABB2B9");


                if (idconceptodet == "4" || idconceptodet == "8") {
                    $("#zfacturaboleta-tab").addClass("disabled");
                    $("#zplanillamovilidad-tab").removeClass("disabled");
                    $("#zdeclaracionjur-tab").addClass("disabled");

                    $('#zregComprobModal .nav-tabs #zplanillamovilidad-tab').tab('show');
                    ztabSeleccionado = 2;

                }
                else {
                    $("#zfacturaboleta-tab").removeClass("disabled");
                    $("#zplanillamovilidad-tab").addClass("disabled");
                    $("#zdeclaracionjur-tab").removeClass("disabled");

                    $("#zregComprobModal .nav-tabs #zfacturaboleta-tab").tab('show');
                    ztabSeleccionado = 1;
                }


                $("#zregComprobModal").modal("show");

            });

            $("#zbtnRegistrarcomprobante").click(function () {

                if (zdetalleArray.length > 0) {

                    let valorRestante = 0;

                    zlimpiarControlModal(1);
                    zlimpiarControlModal(2);
                    zlimpiarControlModal(3);


                    // FACTURA Y BOLETA
                    $("#zfacturaboleta-tab").removeClass("disabled");
                    $("#zplanillamovilidad-tab").removeClass("disabled");
                    $("#zdeclaracionjur-tab").removeClass("disabled");

                    $("#zregComprobModal .nav-tabs #zfacturaboleta-tab").tab('show');

                    zTIPO_REGISTRO = "INSERTAR";

                    $("#ztxtCeCoModal1").val(zsolicitudSeleccionada.ceco);
                    $("#ztxtCeCoModal2").val(zsolicitudSeleccionada.ceco);
                    $("#ztxtCeCoModal3").val(zsolicitudSeleccionada.ceco);

                    $("#ztxtDNIModal2").val(zsolicitudSeleccionada.canvar_bnf);
                    $("#ztxtDNIModal3").val(zsolicitudSeleccionada.canvar_bnf);
                    $("#ztxtApeNomModal2").val(zsolicitudSeleccionada.colaborador);
                    $("#ztxtApeNomModal3").val(zsolicitudSeleccionada.colaborador);

                    for (var i = 0; i < zdetalleArray.length; i++) {
                        valorRestante = valorRestante + zdetalleArray[i].totalrestante;
                    }

                    $("#zkpiMontoSeleecionadoModal1").text(zsolicitudSeleccionada.simbolo + " " + formatoNumero(valorRestante));
                    $("#zkpiMontoSeleecionadoModal2").text(zsolicitudSeleccionada.simbolo + " " + formatoNumero(valorRestante));
                    $("#zkpiMontoSeleecionadoModal3").text(zsolicitudSeleccionada.simbolo + " " + formatoNumero(valorRestante));

                    $("#zregComprobModal .kpi-modal-monto1").css("background-color", "#ABB2B9");
                    $("#zregComprobModal .kpi-modal-monto2").css("background-color", "#ABB2B9");
                    $("#zregComprobModal .kpi-modal-monto3").css("background-color", "#ABB2B9");

                    $("#zregComprobModal").modal("show");
                }
                else {
                    Swal.fire({
                        title: 'Seleccione el detalle de la Solicitud para le registro de Comprobante',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
            });

        });


        $('#zproveedorModal').on('shown.bs.modal', function (e) {
            let rucIngresado = $("#ztxtRucCompModal1").val();

            $("#ztxtRUCModal").val(rucIngresado);
            document.getElementById("ztxtRSModal").focus = true;
        });

        $('#zproveedorModal').on('hidden.bs.modal', function (e) {
            $("#ztxtRUCModal").val("");
            $("#ztxtRSModal").val("");
            $("#ztxtDireccionModal").val("");
        });


        $('#ztxtDNIModal2').keypress(function (event) {
            var keycode = (event.keyCode ? event.keyCode : event.which);

            if (keycode == '13') {
                let dni = $("#ztxtDNIModal2").val().trim();
                busquedaXDNI(dni, ztabSeleccionado)
            }
        });

        $('#ztxtDNIModal3').keypress(function (event) {
            var keycode = (event.keyCode ? event.keyCode : event.which);

            if (keycode == '13') {
                let dni = $("#ztxtDNIModal3").val().trim();
                busquedaXDNI(dni, ztabSeleccionado)
            }
        });

        $('#zmodalSolDetInsertar').on('hidden.bs.modal', function (e) {
            $("#ztxtRUCModal").val("");
            $("#ztxtRSModal").val("");
            $("#ztxtDireccionModal").val("");
        });



        $("#zbtnAgregarMotivo1").click(function () {


            if (zvalidacionDetGuardarCpte(ztabSeleccionado)) {

                let cantidad = parseFloat($("#ztxtCantidad1").val());
                let valorUnitarioTotal = parseFloat($("#ztxtValorUnitarioTotal1").val());
                let valorUnitario = 0;

                if ($("#zcbxTipoCpbteCompModal1").val().trim() == "1") {
                    valorUnitario = (valorUnitarioTotal) / ((PORCENTAJE_IGV / 100) + 1);

                }
                else if ($("#zcbxTipoCpbteCompModal1").val().trim() == "2") {
                    valorUnitario = (valorUnitarioTotal);
                }

                let total = (cantidad * valorUnitarioTotal);


                const sumDetalleSol = zdetalleArray.reduce((acc, item) => {
                    return acc += item.totalrestante
                }, 0);

                const sumAgregadosDet = zdetComprobanteArray1.reduce((acc, item) => {
                    return acc += item.total;
                }, 0);


                if ((sumDetalleSol - (sumAgregadosDet + total)) < 0) {
                    $("#zregComprobModal .kpi-modal-monto1").css("background-color", "#ABB2B9");
                }
                else {
                    $("#zregComprobModal .kpi-modal-monto1").css("background-color", "#ABB2B9");
                }

                ziDetalle1++;

                var d = new Date(), month = '' + (d.getMonth() + 1), day = '' + d.getDate(), year = d.getFullYear();
                if (month.length < 2) { month = '0' + month; }
                if (day.length < 2) { day = '0' + day; }

                zdetComprobanteArray1.push({
                    iDetalle: ziDetalle1,
                    fecha: [year, month, day].join('/'),
                    fechaBD: [year, month, day].join(''),
                    detalle1: ($("#zcbxTipoCpbteCompModal1").val().trim() == "1" ? $("#ztxtDescripcion1").val() : $("#ztxtObsCompModal1").val()),
                    detalle2: "",
                    codum: $("#zcbxUM1").val(),
                    valorunit: valorUnitario,
                    cantidad: cantidad,
                    total: total
                });


                let tabla = $("#ztblFacturaBoleta").DataTable();

                tabla.destroy();
                var tr = "";

                zdetComprobanteArray1.forEach((obj) => {

                    tr += "<tr> "
                        + " <td> " + obj.codum + "</td>"
                        + " <td> " + obj.detalle1 + "</td>"
                        + " <td> " + obj.cantidad + "</td>"
                        + " <td> " + formatoNumero(obj.valorunit) + "</td>"
                        + " <td> " + formatoNumero(obj.total) + "</td>"
                        + " <td class='text-center'>"
                        + "     <button data-idetalle='" + obj.iDetalle + "' data-toggle='collapse' class='btn btn-sm btn-danger cselectEliminar1 ml-1'><i class='fas fa-trash'></i></button>"
                        + "</td>"
                        + "</tr>";
                });

                $("#ztblFacturaBoletaContent").html(tr);

                $("#ztblFacturaBoleta").DataTable(
                    {
                        'language': { 'url': '/libs/datatables/spanish.json' },
                        lengthMenu: [[3], [3]]
                    });



                const importeTotal = zdetComprobanteArray1.reduce((acc, item) => {
                    return acc += (item.valorunit);
                }, 0);


                if ($("#zcbxTipoCpbteCompModal1").val().trim() == "1") {
                    // FACTURA
                    $("#zidimportetotal1").val(formatoNumero(importeTotal));
                    $("#zidigv1").val(formatoNumero(importeTotal * (PORCENTAJE_IGV / 100)));
                    $("#zidtotal1").val(formatoNumero(importeTotal + (importeTotal * (PORCENTAJE_IGV / 100))));

                    $("#ztxtDescripcion1").val("");
                    $("#ztxtCantidad1").val("");
                    $("#ztxtValorUnitarioTotal1").val("");

                    document.getElementById("zcbxUM1").focus = true;
                }
                else if ($("#zcbxTipoCpbteCompModal1").val().trim() == "2") {
                    // BOLETA
                    $("#zidimportetotal1").val(formatoNumero(importeTotal));
                    $("#zidigv1").val(0);
                    $("#zidtotal1").val(formatoNumero(importeTotal));

                    $("#zcbxUM1").val("UN");
                    $("#ztxtDescripcion1").val("");
                    $("#ztxtCantidad1").val("1");
                    $("#ztxtValorUnitarioTotal1").val("");

                    document.getElementById("ztxtValorUnitarioTotal1").focus = true;
                }

                $("#zkpiMontoSeleecionadoModal1").text(zsolicitudSeleccionada.simbolo + " " + formatoNumero(sumDetalleSol - (sumAgregadosDet + total)));

            }
        });

        $("#zbtnAgregarMotivo2").click(function () {

            if (zvalidacionDetGuardarCpte(ztabSeleccionado)) {

                let importeIngresado = parseFloat($("#ztxtImporteModal2").val());

                const sumDetalleSol = zdetalleArray.reduce((acc, item) => {
                    return acc += item.totalrestante
                }, 0);

                const sumAgregadosDet = zdetComprobanteArray2.reduce((acc, item) => {
                    return acc += (item.valorunit * item.cantidad);
                }, 0);


                if ((sumDetalleSol - (sumAgregadosDet + importeIngresado)) < 0) {
                    $("#zregComprobModal .kpi-modal-monto2").css("background-color", "#ABB2B9");
                }
                else {
                    $("#zregComprobModal .kpi-modal-monto2").css("background-color", "#ABB2B9");
                }

                ziDetalle2++;



                var d = new Date($("#ztxtFechaModalDet2").val());

                let month = '' + (d.getMonth() + 1);

                let diaNumero = parseInt(d.getDate()) + 1;

                let day = '' + diaNumero;
                let year = d.getFullYear();

                if (month.length < 2) { month = '0' + month; }
                if (day.length < 2) { day = '0' + day; }



                zdetComprobanteArray2.push({
                    iDetalle: ziDetalle2,
                    fecha: [year, month, day].join('-'),
                    fechaBD: [year, month, day].join(''),
                    detalle1: $("#ztxtOrgDstModal2").val(),
                    detalle2: $("#ztxtMotivoModal2").val(),
                    codum: "UN", // UNIDAD
                    valorunit: parseFloat($("#ztxtImporteModal2").val()),
                    cantidad: 1
                });


                let tabla = $("#ztblPlanillaMovilidad").DataTable();

                tabla.destroy();
                var tr = "";

                zdetComprobanteArray2.forEach((obj) => {

                    tr += "<tr> "
                        + " <td> " + obj.fecha + "</td>"
                        + " <td> " + obj.detalle1 + "</td>"
                        + " <td> " + obj.detalle2 + "</td>"
                        + " <td> " + formatoNumero(obj.valorunit) + "</td>"
                        + " <td class='text-center'>"
                        + "     <button data-idetalle='" + obj.iDetalle + "' data-toggle='collapse' class='btn btn-sm btn-danger cselectEliminar2 ml-1'><i class='fas fa-trash'></i></button>"
                        + "</td>"
                        + "</tr>";
                });

                $("#ztblPlanillaMovilidadContent").html(tr);

                $("#ztblPlanillaMovilidad").DataTable(
                    {
                        'language': { 'url': '/libs/datatables/spanish.json' },
                        lengthMenu: [[3], [3]]
                    });

                $("#ztxtOrgDstModal2").val("");
                $("#ztxtMotivoModal2").val("");
                $("#ztxtImporteModal2").val("0");

                document.getElementById("ztxtOrgDstModal2").focus = true;

                $("#zkpiMontoSeleecionadoModal2").text(zsolicitudSeleccionada.simbolo + " " + formatoNumero(sumDetalleSol - (sumAgregadosDet + importeIngresado)));
            }

        });

        $("#zbtnAgregarMotivo3_1").click(function () {

            if (zvalidacionDetGuardarCpte(ztabSeleccionado)) {

                let respuesta = false;
                let importeIngresado = parseFloat($("#ztxtMontoDet3_1").val());

                if (importeIngresado == "0" || importeIngresado == "" || typeof (importeIngresado) == "undefined" || isNaN(importeIngresado)) {

                    Swal.fire({
                        title: 'Ingrese un monto',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if (parseFloat(importeIngresado) <= 0) {

                    Swal.fire({
                        title: 'Ingrese un monto positivo',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });

                }
                else {

                    let sumTotal3 = 0;
                    let v3_TipoMod = $("#zcbxMonedaModal3").val();
                    let v3_maximoS = ztiposComprobantesArray.find(x => x.idTipoComp == parseInt($("#zcbxTipoCpbteCompModal3").val())).maximoSoles;
                    let v3_maximoD = ztiposComprobantesArray.find(x => x.idTipoComp == parseInt($("#zcbxTipoCpbteCompModal3").val())).maximoDolar;

                    // Validar si excede el monto maximo.
                    if (v3_TipoMod.toString() == 1) {

                        // Soles.
                        if (zdetComprobanteArray3.length > 0) {
                            sumTotal3 = zdetComprobanteArray3.reduce((acc, item) => {
                                return acc += item.valorunit * item.cantidad
                            }, 0);
                        }
                        else {
                            sumTotal3 = parseFloat($("#ztxtMontoDet3_1").val());
                        }

                        if (parseFloat(sumTotal3) > v3_maximoS) {
                            respuesta = false;
                            Swal.fire({
                                title: 'El monto máximo permitido es S/.' + v3_maximoS,
                                text: "Textile Sourcing Company",
                                icon: 'warning',
                                showConfirmButton: true,
                                confirmButtonColor: '#3085d6',
                                confirmButtonText: 'Ok'
                            });
                        }
                        else {
                            respuesta = true;
                        }

                    }
                    else if (v3_TipoMod.toString() == 2) {

                        // Dolar.
                        if (zdetComprobanteArray2.length > 0) {
                            sumTotal3 = zdetComprobanteArray3.reduce((acc, item) => {
                                return acc += item.valorunit * item.cantidad
                            }, 0);
                        }
                        else {
                            sumTotal3 = parseFloat($("#ztxtMontoDet3_1").val());
                        }


                        if (parseFloat(sumTotal3) > v3_maximoD) {
                            respuesta = false;
                            Swal.fire({
                                title: 'El monto máximo permitido es U$ ' + v2_maximoD,
                                text: "Textile Sourcing Company",
                                icon: 'warning',
                                showConfirmButton: true,
                                confirmButtonColor: '#3085d6',
                                confirmButtonText: 'Ok'
                            });
                        }
                        else {
                            respuesta = true;
                        }
                    }


                    // Paso la validacion.
                    if (respuesta) {

                        const sumDetalleSol = zdetalleArray.reduce((acc, item) => {
                            return acc += item.totalrestante
                        }, 0);

                        const sumAgregadosDet = zdetComprobanteArray3.reduce((acc, item) => {
                            return acc += (item.valorunit * item.cantidad);
                        }, 0);


                        if ((sumDetalleSol - (sumAgregadosDet + importeIngresado)) < 0) {
                            $("#zregComprobModal .kpi-modal-monto3").css("background-color", "#ABB2B9");
                        }
                        else {
                            $("#zregComprobModal .kpi-modal-monto3").css("background-color", "#ABB2B9");
                        }

                        ziDetalle3++;

                        var d = new Date($("#ztxtFechaModalDet3_1").val());
                        let numDia = 0;


                        let month = '' + (d.getMonth() + 1);

                        numDia = d.getDate();
                        numDia = numDia + 1;

                        let day = '' + numDia;
                        let year = d.getFullYear();

                        if (month.length < 2) { month = '0' + month; }
                        if (day.length < 2) { day = '0' + day; }

                        zdetComprobanteArray3.push({
                            iDetalle: ziDetalle3,
                            fecha: [year, month, day].join('-'),
                            fechaBD: [year, month, day].join(''),
                            detalle1: $("#zcbxMonedaModal3 option:selected").text(),
                            detalle2: "",
                            codum: "UN", // UNIDAD
                            valorunit: parseFloat($("#ztxtMontoDet3_1").val()),
                            cantidad: 1,
                            seccion: 1
                        });

                        let tabla = $("#ztblDeclaracionJurada3_1").DataTable();

                        tabla.destroy();
                        var tr = "";

                        zdetComprobanteArray3.forEach((obj) => {
                            if (obj.seccion == 1) {

                                tr += "<tr> "
                                    + " <td> " + obj.fecha + "</td>"
                                    + " <td> " + obj.detalle1 + "</td>"
                                    + " <td> " + formatoNumero(obj.valorunit) + "</td>"
                                    + " <td class='text-center'>"
                                    + "     <button data-idetalle='" + obj.iDetalle + "' data-toggle='collapse' class='btn btn-sm btn-danger cselectEliminar3_1 ml-1'><i class='fas fa-trash'></i></button>"
                                    + "</td>"
                                    + "</tr>";
                            }
                        });

                        $("#ztblDeclaracionJuradaContent3_1").html(tr);

                        $("#ztblDeclaracionJurada3_1").DataTable(
                            {
                                'language': { 'url': '/libs/datatables/spanish.json' },
                                lengthMenu: [[5], [5]]
                            });

                        $("#ztxtMontoDet3_1").val("");

                        document.getElementById("ztxtFechaModalDet3_1").focus = true;

                        $("#zkpiMontoSeleecionadoModal3").text(zsolicitudSeleccionada.simbolo + " " + formatoNumero(sumDetalleSol - (sumAgregadosDet + importeIngresado)));

                    }
                }
            }
        });


        $("#zbtnAgregarMotivo3_2").click(function () {

            if (zvalidacionDetGuardarCpte(ztabSeleccionado)) {

                let respuesta = false;
                let importeIngresado = parseFloat($("#ztxtMontoDet3_2").val());

                if (importeIngresado == "0" || importeIngresado == "" || typeof (importeIngresado) == "undefined" || isNaN(importeIngresado)) {

                    Swal.fire({
                        title: 'Ingrese un monto',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if (parseFloat(importeIngresado) <= 0) {

                    Swal.fire({
                        title: 'Ingrese un monto positivo',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });

                }
                else {

                    let sumTotal3 = 0;
                    let v3_TipoMod = $("#zcbxMonedaModal3").val();
                    let v3_maximoS = ztiposComprobantesArray.find(x => x.idTipoComp == parseInt($("#zcbxTipoCpbteCompModal3").val())).maximoSoles;
                    let v3_maximoD = ztiposComprobantesArray.find(x => x.idTipoComp == parseInt($("#zcbxTipoCpbteCompModal3").val())).maximoDolar;

                    // Validar si excede el monto maximo.
                    if (v3_TipoMod.toString() == 1) {

                        // Soles.
                        if (zdetComprobanteArray3.length > 0) {
                            sumTotal3 = zdetComprobanteArray3.reduce((acc, item) => {
                                return acc += item.valorunit * item.cantidad
                            }, 0);
                        }
                        else {
                            sumTotal3 = parseFloat($("#ztxtMontoDet3_2").val());
                        }

                        if (parseFloat(sumTotal3) > v3_maximoS) {
                            respuesta = false;
                            Swal.fire({
                                title: 'El monto máximo permitido es S/.' + v3_maximoS,
                                text: "Textile Sourcing Company",
                                icon: 'warning',
                                showConfirmButton: true,
                                confirmButtonColor: '#3085d6',
                                confirmButtonText: 'Ok'
                            });
                        }
                        else {
                            respuesta = true;
                        }

                    }
                    else if (v3_TipoMod.toString() == 2) {

                        // Dolar.
                        if (zdetComprobanteArray2.length > 0) {
                            sumTotal3 = zdetComprobanteArray3.reduce((acc, item) => {
                                return acc += item.valorunit * item.cantidad
                            }, 0);
                        }
                        else {
                            sumTotal3 = parseFloat($("#ztxtMontoDet3_2").val());
                        }

                        if (parseFloat(sumTotal3) > v3_maximoD) {
                            respuesta = false;
                            Swal.fire({
                                title: 'El monto máximo permitido es U$ ' + v2_maximoD,
                                text: "Textile Sourcing Company",
                                icon: 'warning',
                                showConfirmButton: true,
                                confirmButtonColor: '#3085d6',
                                confirmButtonText: 'Ok'
                            });
                        }
                        else {
                            respuesta = true;
                        }
                    }


                    if (respuesta) {

                        const sumDetalleSol = zdetalleArray.reduce((acc, item) => {
                            return acc += item.totalrestante
                        }, 0);

                        const sumAgregadosDet = zdetComprobanteArray3.reduce((acc, item) => {
                            return acc += (item.valorunit * item.cantidad);
                        }, 0);


                        if ((sumDetalleSol - (sumAgregadosDet + importeIngresado)) < 0) {
                            $("#zregComprobModal .kpi-modal-monto3").css("background-color", "#ABB2B9");
                        }
                        else {
                            $("#zregComprobModal .kpi-modal-monto3").css("background-color", "#ABB2B9");
                        }

                        ziDetalle3++;

                        var d = new Date($("#ztxtFechaModalDet3_2").val());

                        let numDia = 0;


                        let month = '' + (d.getMonth() + 1);

                        numDia = d.getDate();
                        numDia = numDia + 1;

                        let day = '' + numDia;

                        let year = d.getFullYear();

                        if (month.length < 2) { month = '0' + month; }
                        if (day.length < 2) { day = '0' + day; }

                        zdetComprobanteArray3.push({
                            iDetalle: ziDetalle3,
                            fecha: [year, month, day].join('-'),
                            fechaBD: [year, month, day].join(''),
                            detalle1: $("#zcbxMonedaModal3 option:selected").text(),
                            detalle2: "",
                            codum: "UN", // UNIDAD
                            valorunit: parseFloat($("#ztxtMontoDet3_2").val()),
                            cantidad: 1,
                            seccion: 2
                        });

                        let tabla = $("#ztblDeclaracionJurada3_2").DataTable();

                        tabla.destroy();
                        var tr = "";

                        zdetComprobanteArray3.forEach((obj) => {
                            if (obj.seccion == 2) {

                                tr += "<tr> "
                                    + " <td> " + obj.fecha + "</td>"
                                    + " <td> " + obj.detalle1 + "</td>"
                                    + " <td> " + formatoNumero(obj.valorunit) + "</td>"
                                    + " <td class='text-center'>"
                                    + "     <button data-idetalle='" + obj.iDetalle + "' data-toggle='collapse' class='btn btn-sm btn-danger cselectEliminar3_2 ml-1'><i class='fas fa-trash'></i></button>"
                                    + "</td>"
                                    + "</tr>";
                            }
                        });

                        $("#ztblDeclaracionJuradaContent3_2").html(tr);

                        $("#ztblDeclaracionJurada3_2").DataTable(
                            {
                                'language': { 'url': '/libs/datatables/spanish.json' },
                                lengthMenu: [[5], [5]]
                            });

                        $("#ztxtMontoDet3_2").val("");

                        document.getElementById("ztxtFechaModalDet3_2").focus = true;

                        $("#zkpiMontoSeleecionadoModal3").text(zsolicitudSeleccionada.simbolo + " " + formatoNumero(sumDetalleSol - (sumAgregadosDet + importeIngresado)));

                    }
                }
            }
        });




        $("#ztblFacturaBoleta").on("click", ".cselectEliminar1", function () {

            let vIDetalle = $(this).attr("data-idetalle");

            for (var i = 0; i < zdetComprobanteArray1.length; i++) {
                if (zdetComprobanteArray1[i].iDetalle == parseInt(vIDetalle)) {
                    zdetComprobanteArray1.splice(i, 1);
                }
            }

            const sumDetalleSol = zdetalleArray.reduce((acc, item) => {
                return acc += item.totalrestante
            }, 0);

            const sumAgregadosDet = zdetComprobanteArray1.reduce((acc, item) => {
                return acc += (item.total);
            }, 0);

            $("#zkpiMontoSeleecionadoModal1").text(zsolicitudSeleccionada.simbolo + " " + formatoNumero(sumDetalleSol - sumAgregadosDet));

            if ((sumDetalleSol - sumAgregadosDet) < 0) {
                $("#zregComprobModal .kpi-modal-monto1").css("background-color", "#ABB2B9");
            }
            else {
                $("#zregComprobModal .kpi-modal-monto1").css("background-color", "#ABB2B9");
            }

            let tabla = $("#ztblFacturaBoleta").DataTable();

            tabla.destroy();
            var tr = "";

            zdetComprobanteArray1.forEach((obj) => {

                tr += "<tr> "
                    + " <td> " + obj.um + "</td>"
                    + " <td> " + obj.detalle1 + "</td>"
                    + " <td> " + obj.cantidad + "</td>"
                    + " <td> " + formatoNumero(obj.valorunit) + "</td>"
                    + " <td> " + formatoNumero(obj.total) + "</td>"
                    + " <td class='text-center'>"
                    + "     <button data-idetalle='" + obj.iDetalle + "' data-toggle='collapse' class='btn btn-sm btn-danger cselectEliminar1 ml-1'><i class='fas fa-trash'></i></button>"
                    + "</td>"
                    + "</tr>";
            });


            $("#ztblFacturaBoletaContent").html(tr);

            $("#ztblFacturaBoleta").DataTable(
                {
                    'language': { 'url': '/libs/datatables/spanish.json' },
                    lengthMenu: [[5], [5]]
                });

            const importeTotal = zdetComprobanteArray1.reduce((acc, item) => {
                return acc += (item.valorunit);
            }, 0);


            if ($("#zcbxTipoCpbteCompModal1").val().trim() == "1") {
                // FACTURA
                $("#ztxtDescripcion1").val("");
                $("#ztxtCantidad1").val("");
                $("#ztxtValorUnitarioTotal1").val("");

                $("#zidimportetotal1").val(formatoNumero(importeTotal));
                $("#zidigv1").val(formatoNumero(importeTotal * (PORCENTAJE_IGV / 100)));
                $("#zidtotal1").val(formatoNumero(importeTotal + (importeTotal * (PORCENTAJE_IGV / 100))));
            }
            else if ($("#zcbxTipoCpbteCompModal1").val().trim() == "2") {
                // BOLETA
                $("#ztxtDescripcion1").val("");
                $("#ztxtCantidad1").val("1");
                $("#ztxtValorUnitarioTotal1").val("");

                $("#zidimportetotal1").val(formatoNumero(importeTotal));
                $("#zidigv1").val(0);
                $("#zidtotal1").val(formatoNumero(importeTotal));
            }


            document.getElementById("zcbxUM1").focus = true;

            $("#zkpiMontoSeleecionadoModal1").text(zsolicitudSeleccionada.simbolo + " " + formatoNumero(sumDetalleSol - sumAgregadosDet));

        });

        $("#ztblPlanillaMovilidad").on("click", ".cselectEliminar2", function () {
            let vIDetalle = $(this).attr("data-idetalle");

            for (var i = 0; i < zdetComprobanteArray2.length; i++) {
                if (zdetComprobanteArray2[i].iDetalle == parseInt(vIDetalle)) {
                    zdetComprobanteArray2.splice(i, 1);
                }
            }

            const sumDetalleSol = zdetalleArray.reduce((acc, item) => {
                return acc += item.totalrestante
            }, 0);

            const sumAgregadosDet = zdetComprobanteArray2.reduce((acc, item) => {
                return acc += item.valorunit;
            }, 0);

            $("#zkpiMontoSeleecionadoModal2").text(zsolicitudSeleccionada.simbolo + " " + formatoNumero(sumDetalleSol - sumAgregadosDet));

            if ((sumDetalleSol - sumAgregadosDet) < 0) {
                $("#zregComprobModal .kpi-modal-monto2").css("background-color", "#ABB2B9");
            }
            else {
                $("#zregComprobModal .kpi-modal-monto2").css("background-color", "#ABB2B9");
            }

            let tabla = $("#ztblPlanillaMovilidad").DataTable();

            tabla.destroy();
            var tr = "";

            zdetComprobanteArray2.forEach((obj) => {

                tr += "<tr> "
                    + " <td> " + obj.fecha + "</td>"
                    + " <td> " + obj.detalle1 + "</td>"
                    + " <td> " + obj.detalle2 + "</td>"
                    + " <td> " + formatoNumero(obj.valorunit) + "</td>"
                    + " <td class='text-center'>"
                    + "     <button data-idetalle='" + obj.iDetalle + "' data-toggle='collapse' class='btn btn-sm btn-danger cselectEliminar2 ml-1'><i class='fas fa-trash'></i></button>"
                    + "</td>"
                    + "</tr>";
            });

            $("#ztblPlanillaMovilidadContent").html(tr);

            $("#ztblPlanillaMovilidad").DataTable(
                {
                    'language': { 'url': '/libs/datatables/spanish.json' },
                    lengthMenu: [[5, 10, 20, -1], [5, 10, 20, 'Todos']]
                });

            $("#ztxtOrgDstModal2").val("");
            $("#ztxtMotivoModal2").val("");
            $("#ztxtImporteModal2").val("0");

            document.getElementById("ztxtOrgDstModal2").focus = true;
        });

        $("#ztblDeclaracionJurada3_1").on("click", ".cselectEliminar3_1", function () {
            let vIDetalle = $(this).attr("data-idetalle");

            for (var i = 0; i < zdetComprobanteArray3.length; i++) {
                if (zdetComprobanteArray3[i].iDetalle == parseInt(vIDetalle)) {
                    zdetComprobanteArray3.splice(i, 1);
                }
            }

            const sumDetalleSol = zdetalleArray.reduce((acc, item) => {
                return acc += item.totalrestante
            }, 0);

            const sumAgregadosDet = zdetComprobanteArray3.reduce((acc, item) => {
                return acc += item.valorunit;
            }, 0);

            $("#zkpiMontoSeleecionadoModal3").text(zsolicitudSeleccionada.simbolo + " " + formatoNumero(sumDetalleSol - sumAgregadosDet));

            if ((sumDetalleSol - sumAgregadosDet) < 0) {
                $("#zregComprobModal .kpi-modal-monto3").css("background-color", "#ABB2B9");
            }
            else {
                $("#zregComprobModal .kpi-modal-monto3").css("background-color", "#ABB2B9");
            }

            let tabla = $("#ztblDeclaracionJurada3_1").DataTable();

            tabla.destroy();
            var tr = "";


            zdetComprobanteArray3.forEach((obj) => {

                if (obj.seccion == 1) {
                    tr += "<tr> "
                        + " <td> " + obj.fecha + "</td>"
                        + " <td> " + obj.detalle1 + "</td>"
                        + " <td> " + formatoNumero(obj.valorunit) + "</td>"
                        + " <td class='text-center'>"
                        + "     <button data-idetalle='" + obj.iDetalle + "' data-toggle='collapse' class='btn btn-sm btn-danger cselectEliminar3_1 ml-1'><i class='fas fa-trash'></i></button>"
                        + "</td>"
                        + "</tr>";
                }
            });

            $("#ztblDeclaracionJuradaContent3_1").html(tr);

            $("#ztblDeclaracionJurada3_1").DataTable(
                {
                    'language': { 'url': '/libs/datatables/spanish.json' },
                    lengthMenu: [[5], [5]]
                });

            $("#ztxtMontoDet3_1").val("");

            document.getElementById("ztxtFechaModalDet3_1").focus = true;
        });

        $("#ztblDeclaracionJurada3_2").on("click", ".cselectEliminar3_2", function () {
            let vIDetalle = $(this).attr("data-idetalle");

            for (var i = 0; i < zdetComprobanteArray3.length; i++) {
                if (zdetComprobanteArray3[i].iDetalle == parseInt(vIDetalle)) {
                    zdetComprobanteArray3.splice(i, 1);
                }
            }

            const sumDetalleSol = zdetalleArray.reduce((acc, item) => {
                return acc += item.totalrestante
            }, 0);

            const sumAgregadosDet = zdetComprobanteArray3.reduce((acc, item) => {
                return acc += item.valorunit;
            }, 0);

            $("#zkpiMontoSeleecionadoModal3").text(zsolicitudSeleccionada.simbolo + " " + formatoNumero(sumDetalleSol - sumAgregadosDet));

            if ((sumDetalleSol - sumAgregadosDet) < 0) {
                $("#zregComprobModal .kpi-modal-monto3").css("background-color", "#ABB2B9");
            }
            else {
                $("#zregComprobModal .kpi-modal-monto3").css("background-color", "#ABB2B9");
            }

            let tabla = $("#ztblDeclaracionJurada3_2").DataTable();

            tabla.destroy();
            var tr = "";


            zdetComprobanteArray3.forEach((obj) => {

                if (obj.seccion == 1) {
                    tr += "<tr> "
                        + " <td> " + obj.fecha + "</td>"
                        + " <td> " + obj.detalle1 + "</td>"
                        + " <td> " + formatoNumero(obj.valorunit) + "</td>"
                        + " <td class='text-center'>"
                        + "     <button data-idetalle='" + obj.iDetalle + "' data-toggle='collapse' class='btn btn-sm btn-danger cselectEliminar3_2 ml-1'><i class='fas fa-trash'></i></button>"
                        + "</td>"
                        + "</tr>";
                }
            });

            $("#ztblDeclaracionJuradaContent3_2").html(tr);

            $("#ztblDeclaracionJurada3_2").DataTable(
                {
                    'language': { 'url': '/libs/datatables/spanish.json' },
                    lengthMenu: [[5], [5]]
                });

            $("#ztxtMontoDet3_2").val("");

            document.getElementById("ztxtFechaModalDet3_2").focus = true;
        });


        $("#zbtnGuardarComprobante").click(function () {

            if (zvalidacionGuardarComp(ztabSeleccionado)) {

                let parametro = {};
                let opcion = 0;

                if (zTIPO_REGISTRO == "INSERTAR") {
                    opcion = 1;
                }
                else if (zTIPO_REGISTRO == "EDITAR") {
                    opcion = 6;
                }


                if (ztabSeleccionado == 1) {

                    // 1. Facturas / Boletas
                    parametro = {
                        'opcion': opcion,
                        'idRendCompte': zvIdRendCompte,
                        'idTipoComp': parseInt($("#zcbxTipoCpbteCompModal1").val()),

                        'nserie': $("#ztxtSerieModal1").val(),
                        'ndocof': $("#ztxtNumeroModal1").val(),

                        'rucDNI': $("#ztxtRucCompModal1").val(),
                        'rs': $("#ztxtRSCompModal1").val(),
                        'codigoPC': $("#ztxtCodSofyaPCModal1").val(),
                        'obs': $("#ztxtObsCompModal1").val(),
                        'fechaEmision': FormatoFecha($("#ztxtFechaModal1").val()),
                        'codceco': zsolicitudSeleccionada.codceco,
                        'idTipoMod': parseInt($("#zcbxMonedaModal1").val()),
                        'porcentajeIGV': (($("#zcbxTipoCpbteCompModal1").val().trim() == "1") ? PORCENTAJE_IGV : 0),
                        'obs1': '',
                        'obs2': '',
                        'fecha1': '',
                        'fecha2': '',
                        'periodo': $("#zcbxPeriodoModal1").val(),
                        'solitudSeqArray': zdetalleArray,
                        'detalleComprobanteArray': zdetComprobanteArray1
                    };

                }
                else if (ztabSeleccionado == 2) {

                    // 2. Planilla de Movilidad
                    parametro = {
                        'opcion': opcion,
                        'idRendCompte': zvIdRendCompte,
                        'idTipoComp': 3,

                        'nserie': "000",
                        'ndocof': FormatoFecha($("#ztxtFechaModal2").val()),

                        'rucDNI': $("#ztxtDNIModal2").val(),
                        'rs': $("#ztxtApeNomModal2").val(),
                        'codigoPC': $("#ztxtDNIModal2").val(),
                        'obs': "PLANILLA DE MOVILIDAD - " + $("#ztxtColaborador").val(),
                        'fechaEmision': $("#ztxtFechaModal2").val(),
                        'codceco': zsolicitudSeleccionada.codceco,
                        'idTipoMod': parseInt($("#zcbxMonedaModal2").val()),
                        'porcentajeIGV': 0,
                        'obs1': '',
                        'obs2': '',
                        'fecha1': '',
                        'fecha2': '',
                        'periodo': $("#zcbxPeriodoModal2").val(),

                        'solitudSeqArray': zdetalleArray,
                        'detalleComprobanteArray': zdetComprobanteArray2
                    };

                }
                else if (ztabSeleccionado == 3) {

                    // 2. Declaracion Jurada

                    parametro = {
                        'opcion': opcion,
                        'idRendCompte': zvIdRendCompte,
                        'idTipoComp': 4,

                        'nserie': "000",
                        'ndocof': FormatoFecha($("#ztxtFechaModal3").val()),

                        'rucDNI': $("#ztxtDNIModal3").val(),
                        'rs': $("#ztxtApeNomModal3").val(),
                        'codigoPC': $("#ztxtDNIModal3").val(),
                        'obs': "DECLARACIÓN JURADA - " + $("#ztxtColaborador").val(),
                        'fechaEmision': $("#ztxtFechaModal3").val(),
                        'codceco': zsolicitudSeleccionada.codceco,
                        'idTipoMod': parseInt($("#zcbxMonedaModal3").val()),
                        'porcentajeIGV': 0,
                        'obs1': $("#txtCiudadModal3").val(),
                        'obs2': $("#ztxtPaisModal3").val(),
                        'fecha1': FormatoFecha($("#ztxtFechaDesdeModal3").val()),
                        'fecha2': FormatoFecha($("#ztxtFechaHastaModal3").val()),
                        'periodo': $("#zcbxPeriodoModal3").val(),

                        'solitudSeqArray': zdetalleArray,
                        'detalleComprobanteArray': zdetComprobanteArray3
                    };
                }


                $.ajax({
                    url: "/finanzas/RG_SetRendicionComprobante",
                    type: "post",
                    data: parametro,
                    dataType: "json",
                    success: function (resultado) {

                        if (resultado.isRedirect) {
                            window.location.href = resultado.redirectUrl;
                        }
                        else {
                            if (resultado.entidad.idResponse > 0) {

                                zdetalleArray = [];

                                zdetComprobanteArray1 = [];
                                zdetComprobanteArray2 = [];
                                zdetComprobanteArray3 = [];

                                zlimpiarControlModal(1);
                                zlimpiarControlModal(2);
                                zlimpiarControlModal(3);

                                zvalidarEstadoSolicitud(2, zsolicitudSeleccionada.idSolicitud);
                                zactualizarLista(zsolicitudSeleccionada.idSolicitud);

                                $("#zregComprobModal").modal("hide");

                            }
                            else {
                                zmensajePrincipal(false, resultado.entidad.statusResponse);
                            }
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {

                    }
                });



            }
        });

        function FormatoFecha(pFecha) {
            let fechaFormato = new Date(pFecha);
            let dia = fechaFormato.getDate() + 1;

            let month = '' + (fechaFormato.getMonth() + 1);
            let day = '' + dia;
            let year = fechaFormato.getFullYear();

            if (month.length < 2) { month = '0' + month; }
            if (day.length < 2) { day = '0' + day; }

            return [year, month, day].join('');
        }


        $('#zcbxTipoCpbteCompModal1').change(function () {

            var $option = $(this).find('option:selected');
            let vCodTipoComprobante = parseInt($option.val());

            zdefinirValoresTipoCpte(vCodTipoComprobante);

            zdetComprobanteArray1 = [];

            let tabla = $("#ztblFacturaBoleta").DataTable();
            tabla.destroy();
            var tr = "";
            $("#ztblFacturaBoletaContent").html(tr);
            $("#ztblFacturaBoleta").DataTable(
                {
                    'language': { 'url': '/libs/datatables/spanish.json' },
                    lengthMenu: [[3], [3]]
                }
            );


        });


        function zdefinirValoresTipoCpte(vCodTipoComprobante) {
            // Limpiar TAB Factura Boleta

            if (vCodTipoComprobante == 1) {
                // Factura
                document.getElementById("zcbxTipoCpbteCompModal1").disabled = false;

                document.getElementById("ztxtObsCompModal1").disabled = false;

                document.getElementById("zcbxUM1").disabled = false;
                document.getElementById("ztxtDescripcion1").disabled = false;
                document.getElementById("ztxtCantidad1").disabled = false;
                document.getElementById("ztxtValorUnitarioTotal1").disabled = false;

                document.getElementById("zidimportetotal1").disabled = true;
                document.getElementById("zidigv1").disabled = true;
                document.getElementById("zidtotal1").disabled = true;
            }
            else if (vCodTipoComprobante == 2) {
                // Boleta
                document.getElementById("zcbxTipoCpbteCompModal1").disabled = false;
                //document.getElementById("txtSerieNumCompModal1").disabled = false;
                document.getElementById("ztxtObsCompModal1").disabled = false;

                document.getElementById("zcbxUM1").disabled = true;
                document.getElementById("ztxtDescripcion1").disabled = true;
                document.getElementById("ztxtCantidad1").disabled = true;
                document.getElementById("ztxtValorUnitarioTotal1").disabled = false;

                $("#ztxtDescripcion1").val("");
                $("#zcbxUM1").val("UN");
                $("#ztxtCantidad1").val(1);

                document.getElementById("ztxtValorUnitarioTotal1").focus = true;
            }

            document.getElementById("zidimportetotal1").disabled = true;
            document.getElementById("zidigv1").disabled = true;
            document.getElementById("zidtotal1").disabled = true;

            $("#zidimportetotal1").val("0");
            $("#zidigv1").val("0");
            $("#zidtotal1").val("0");

        }






        $("#ztabRendicionGastos").on("click", ".zctabRegComp", function () {
            let index = $(this).attr("data-id");
            ztabSeleccionado = parseInt(index);
        });

        $('.cfecha').change(function () {

            var inputDate = new Date(this.value);
            var today = new Date();

            if (inputDate > today) {

                let dd = String(today.getDate()).padStart(2, '0');
                let mm = String(today.getMonth() + 1).padStart(2, '0');
                let yyyy = today.getFullYear();

                today = yyyy + '-' + mm + '-' + dd;

                $(this).val(today);

                Swal.fire({
                    title: 'La fecha no puede ser mayor a la fecha Actual',
                    text: "Textile Sourcing Company",
                    icon: 'warning',
                    showConfirmButton: true,
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'Ok'
                });
            }

        });

        $('#zregComprobModal').on('shown.bs.modal', function (e) {
            var now = new Date();
            var month = (now.getMonth() + 1);
            var day = now.getDate();
            if (month < 10)
                month = "0" + month;
            if (day < 10)
                day = "0" + day;
            var today = now.getFullYear() + '-' + month + '-' + day;

            $('#ztxtFechaModal1').val(today);
            $('#ztxtFechaModal2').val(today);
            $('#ztxtFechaModal3').val(today);
            $('#ztxtFechaModalDet2').val(today);
            $('#ztxtFechaModalDet3').val(today);
            $('#ztxtFechaDesdeModal3').val(today);
            $('#ztxtFechaHastaModal3').val(today);
            $('#ztxtFechaModalDet3_1').val(today);
            $('#ztxtFechaModalDet3_2').val(today);

            $("#zcbxMonedaModal1").val(zsolicitudSeleccionada.idTipoMod);
            $("#zcbxMonedaModal2").val(zsolicitudSeleccionada.idTipoMod);
            $("#zcbxMonedaModal3").val(zsolicitudSeleccionada.idTipoMod);

            // kkkk

        });

        $('#zregComprobModal').on('hidden.bs.modal', function (e) {

            if (zTIPO_REGISTRO == "INSERTAR") {

                zlimpiarControlModal(1);
                zlimpiarControlModal(2);
                zlimpiarControlModal(3);

                zdetComprobanteArray1 = [];
                zdetComprobanteArray2 = [];
                zdetComprobanteArray3 = [];

                zdetalleArray = [];
            }

        });


        function zvalidacionDetGuardarCpte(tabSeleccion) {
            let respuesta = false;

            let v1_TipoMod = 0;
            let v1_maximoS = 0;
            let v1_maximoD = 0;
            let v2_TipoMod = 0;
            let v2_maximoS = 0;
            let v2_maximoD = 0;


            if (tabSeleccion == 1) {

                let tipoComprobante = $('#zcbxTipoCpbteCompModal1').val();
                let sumTotal1 = 0;

                v1_TipoMod = $("#zcbxMonedaModal1").val();
                v1_maximoS = ztiposComprobantesArray.find(x => x.idTipoComp == parseInt($("#zcbxTipoCpbteCompModal1").val())).maximoSoles;
                v1_maximoD = ztiposComprobantesArray.find(x => x.idTipoComp == parseInt($("#zcbxTipoCpbteCompModal1").val())).maximoDolar;


                let desc= $("#ztxtDescripcion1").val();

                if ($("#zcbxTipoCpbteCompModal1").val().trim() == "0") {
                    respuesta = false;

                    Swal.fire({
                        title: 'Seleccione un Tipo de Comprobante',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if ($("#zcbxUM1").val() == "0" && tipoComprobante == "1") {
                    respuesta = false;

                    Swal.fire({
                        title: 'Seleccione una unidad de medida por favor',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if ($("#ztxtDescripcion1").val().trim() == "" && (tipoComprobante == "1")) {
                    respuesta = false;
                    Swal.fire({
                        title: 'Ingrese la descripción por favor',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if (($("#ztxtCantidad1").val().trim() == "" || $("#ztxtCantidad1").val() == null || typeof ($("#ztxtCantidad1").val()) == "undefined") && (tipoComprobante == "1")) {
                    respuesta = false;
                    Swal.fire({
                        title: 'Ingrese la cantidad por favor',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if ((parseFloat($("#ztxtCantidad1").val()) == 0 || parseFloat($("#ztxtCantidad1").val()) < 0 || parseFloat($("#ztxtCantidad1").val()) > 50) && (tipoComprobante == "1")) {
                    respuesta = false;
                    Swal.fire({
                        title: 'Ingrese una cantidad correcta por favor',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if (($("#ztxtValorUnitarioTotal1").val().trim() == "" || $("#ztxtValorUnitarioTotal1").val() == null || typeof ($("#ztxtValorUnitarioTotal1").val()) == "undefined") && (tipoComprobante == "1")) {
                    respuesta = false;
                    Swal.fire({
                        title: 'Ingrese el valor Unitario',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if ((parseFloat($("#ztxtValorUnitarioTotal1").val()) == 0 || parseFloat($("#ztxtValorUnitarioTotal1").val()) < 0 || parseFloat($("#ztxtValorUnitarioTotal1").val()) > 1500) && (tipoComprobante == "1" || tipoComprobante == "2")) {
                    respuesta = false;
                    Swal.fire({
                        title: 'Ingrese un Valor unitario correcto por favor',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if (v1_TipoMod.toString() == 1) {

                    if (zdetComprobanteArray1.length > 0) {
                        sumTotal1 = zdetComprobanteArray1.reduce((acc, item) => {
                            return acc += item.valorunit * item.cantidad
                        }, 0);
                    }
                    else {
                        sumTotal1 = parseFloat($("#ztxtValorUnitarioTotal1").val()) * parseFloat($("#ztxtCantidad1").val());
                    }

                    // Soles.
                    if (sumTotal1 > v1_maximoS) {
                        respuesta = false;
                        Swal.fire({
                            title: 'El monto máximo permitido es S/.' + v1_maximoS,
                            text: "Textile Sourcing Company",
                            icon: 'warning',
                            showConfirmButton: true,
                            confirmButtonColor: '#3085d6',
                            confirmButtonText: 'Ok'
                        });
                    }
                    else {
                        respuesta = true;
                    }

                }
                else if (v1_TipoMod.toString() == 2) {

                    // Soles.
                    if (zdetComprobanteArray1.length > 0) {
                        sumTotal1 = zdetComprobanteArray1.reduce((acc, item) => {
                            return acc += item.valorunit * item.cantidad
                        }, 0);
                    }
                    else {
                        sumTotal1 = parseFloat($("#ztxtValorUnitarioTotal1").val()) * parseFloat($("#ztxtCantidad1").val());
                    }

                    if (sumTotal1 > v1_maximoD) {
                        respuesta = false;
                        Swal.fire({
                            title: 'El monto máximo permitido es U$ ' + v1_maximoD,
                            text: "Textile Sourcing Company",
                            icon: 'warning',
                            showConfirmButton: true,
                            confirmButtonColor: '#3085d6',
                            confirmButtonText: 'Ok'
                        });
                    }
                    else {
                        respuesta = true;
                    }
                }
                else {
                    respuesta = true;
                }

            }
            else if (tabSeleccion == 2) {

                v2_TipoMod = $("#zcbxMonedaModal2").val();
                let sumTotal2 = 0;

                v2_maximoS = ztiposComprobantesArray.find(x => x.idTipoComp == parseInt($("#zcbxTipoCpbteCompModal2").val())).maximoSoles;
                v2_maximoD = ztiposComprobantesArray.find(x => x.idTipoComp == parseInt($("#zcbxTipoCpbteCompModal2").val())).maximoDolar;


                if ($("#ztxtApeNomModal2").val().trim() == "") {
                    respuesta = false;

                    Swal.fire({
                        title: 'Ingrese Apellidos y Nombres',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if ($("#ztxtDNIModal2").val().trim() == "") {
                    respuesta = false;

                    Swal.fire({
                        title: "Ingrese el número de DNI",
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if ($("#ztxtApeNomModal2").val().trim() == "0 Ninguno" || $("#ztxtApeNomModal2").val().trim() == "0 Varios") {
                    respuesta = false;

                    Swal.fire({
                        title: 'Colaborador no existe',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if ($("#ztxtOrgDstModal2").val().trim() == "") {
                    respuesta = false;

                    Swal.fire({
                        title: 'Ingrese una descripción de Origen/Destino',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if ($("#ztxtMotivoModal2").val().trim() == "") {
                    respuesta = false;

                    Swal.fire({
                        title: 'Ingrese una descripción del motivo',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if ($("#ztxtImporteModal2").val().trim() == "" || $("#ztxtImporteModal2").val().trim() == "0") {
                    respuesta = false;

                    Swal.fire({
                        title: 'Ingrese el importe por favor',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                //else if (v2_TipoMod.toString() == 1) {

                //    // Soles.
                //    if (zdetComprobanteArray2.length > 0) {
                //        sumTotal2 = zdetComprobanteArray2.reduce((acc, item) => {
                //            return acc += item.valorunit * item.cantidad
                //        }, 0);
                //    }
                //    else {
                //        sumTotal2 = $("#ztxtImporteModal2").val();
                //    }

                //    if (parseFloat(sumTotal2) > v2_maximoS) {
                //        respuesta = false;
                //        Swal.fire({
                //            title: 'El monto máximo permitido es S/.' + v2_maximoS,
                //            text: "Textile Sourcing Company",
                //            icon: 'warning',
                //            showConfirmButton: true,
                //            confirmButtonColor: '#3085d6',
                //            confirmButtonText: 'Ok'
                //        });
                //    }
                //    else {
                //        respuesta = true;
                //    }

                //}
                //else if (v2_TipoMod.toString() == 2) {

                //    // Dolar.
                //    if (zdetComprobanteArray2.length > 0) {
                //        sumTotal2 = zdetComprobanteArray2.reduce((acc, item) => {
                //            return acc += item.valorunit * item.cantidad
                //        }, 0);
                //    }
                //    else {
                //        sumTotal2 = $("#ztxtImporteModal2").val();
                //    }


                //    if (parseFloat(sumTotal2) > v2_maximoD) {
                //        respuesta = false;
                //        Swal.fire({
                //            title: 'El monto máximo permitido es U$ ' + v2_maximoD,
                //            text: "Textile Sourcing Company",
                //            icon: 'warning',
                //            showConfirmButton: true,
                //            confirmButtonColor: '#3085d6',
                //            confirmButtonText: 'Ok'
                //        });
                //    }
                //    else {
                //        respuesta = true;
                //    }
                //}

                else {
                    respuesta = true;
                }
            }
            else if (tabSeleccion == 3) {

                if ($("#ztxtCiudadModal3").val().trim() == "") {
                    respuesta = false;

                    Swal.fire({
                        title: 'Ingrese el nombre de la Ciudad',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if ($("#ztxtPaisModal3").val().trim() == "") {
                    respuesta = false;

                    Swal.fire({
                        title: "Ingrese el nombre del País",
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else {
                    respuesta = true;
                }
            }

            return respuesta;
        }

        function zvalidacionGuardarComp(indexTab) {
            var respuesta = false;

            if (indexTab == 1) {
                // Registro de Factura y Boleta
                let tipoComprobante = $('#zcbxTipoCpbteCompModal1').val();

                if ($("#zcbxTipoCpbteCompModal1").val().trim() == "0" && (tipoComprobante == "1" || tipoComprobante == "2")) {
                    respuesta = false;

                    Swal.fire({
                        title: 'Seleccione un Tipo de Comprobante',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if ($("#ztxtSerieModal1").val().trim() == "" && (tipoComprobante == "1" || tipoComprobante == "2")) {
                    respuesta = false;

                    Swal.fire({
                        title: 'Ingrese al serie del comprobante',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if ($("#ztxtNumeroModal1").val().trim() == "" && (tipoComprobante == "1" || tipoComprobante == "2")) {
                    respuesta = false;

                    Swal.fire({
                        title: 'Ingrese el numero del comprobante',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if ($("#ztxtRucCompModal1").val().trim() == "" && (tipoComprobante == "1" || tipoComprobante == "2")) {
                    respuesta = false;

                    Swal.fire({
                        title: 'Ingrese el número de RUC / DNI',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if ($("#ztxtCodSofyaPCModal1").val().trim() == "" && (tipoComprobante == "1" || tipoComprobante == "2")) {
                    respuesta = false;

                    Swal.fire({
                        title: 'El zproveedor debe estar registrado en Sofya para continuar',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if (zdetComprobanteArray1.length == 0 && (tipoComprobante == "1" || tipoComprobante == "2")) {
                    respuesta = false;

                    Swal.fire({
                        title: 'Debe agregar el detalle del comprobante',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }

                else {
                    respuesta = true;
                }
            }
            if (indexTab == 2) {

                // Planilla de Movilidad

                if ($("#ztxtDNIModal2").val().trim() == "") {
                    respuesta = false;

                    Swal.fire({
                        title: 'No se encuentra el colaborador',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if (zdetComprobanteArray2.length == 0) {
                    respuesta = false;

                    Swal.fire({
                        title: 'Debe agregar el detalle de Planilla de Movilidad',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else {
                    respuesta = true;
                }
            }
            else if (indexTab == 3) {

                // Declaracion Jurada
                if ($("#zcbxMonedaModal3").val().trim() == "0") {
                    respuesta = false;

                    Swal.fire({
                        title: 'Ingrese el tipo de Moneda',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });

                }
                else if ($("#ztxtDNIModal3").val().trim() == "") {
                    respuesta = false;

                    Swal.fire({
                        title: 'Ingrese el número de DNI por favor',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else if (zdetComprobanteArray3.length == 0) {
                    respuesta = false;

                    Swal.fire({
                        title: 'Debe agregar el detalle de la Declaración Jurada',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Ok'
                    });
                }
                else {
                    respuesta = true;
                }
            }


            return respuesta;
        }


        function zlimpiarControlModal(tabSeleccion) {

            var now = new Date();
            var month = (now.getMonth() + 1);
            var day = now.getDate();
            if (month < 10)
                month = "0" + month;
            if (day < 10)
                day = "0" + day;
            var today = now.getFullYear() + '-' + month + '-' + day;


            if (tabSeleccion == 1) {

                // 1. Factura y Boleta
                //$("#zcbxTipoCpbteCompModal1").val(0);

                let tipoCpte = $("#zcbxTipoCpbteCompModal1").val();

                $("#ztxtFechaModal1").val(today);

                $("#ztxtSerieModal1").val("");
                $("#ztxtNumeroModal1").val("");

                $("#ztxtRucCompModal1").val("");
                $("#ztxtRSCompModal1").val("");
                $("#ztxtCodSofyaPCModal1").val("");
                $("#ztxtObsCompModal1").val("");

                $("#zcbxUM1").val("UN");
                $("#ztxtDescripcion1").val("");
                $("#ztxtCantidad1").val("");
                $("#ztxtValorUnitarioTotal1").val("");

                $("#zidimportetotal1").val("0");
                $("#zidigv1").val("0");
                $("#zidtotal1").val("0");

                $("#zkpiMontoSeleecionadoModal1").text("0.00");
                document.getElementById("zcbxTipoCpbteCompModal1").disabled = false;

                let tabla = $("#ztblFacturaBoleta").DataTable();
                tabla.destroy();
                var tr = "";
                $("#ztblFacturaBoletaContent").html(tr);
                $("#ztblFacturaBoleta").DataTable(
                    {
                        'language': { 'url': '/libs/datatables/spanish.json' },
                        lengthMenu: [[3], [3]]
                    }
                );

                zdefinirValoresTipoCpte(tipoCpte);

            }
            else if (tabSeleccion == 2) {

                // 2. Planilla de Movilidad
                $("#ztxtNumPlanillaModal2").val("");
                $("#ztxtApeNomModal2").val("");
                $("#ztxtDNIModal2").val("");
                $("#ztxtCeCoModal2").val("");

                $("#ztxtFechaModal2").val(today);
                $("#ztxtOrgDstModal2").val("");
                $("#ztxtMotivoModal2").val("");
                $("#ztxtImporteModal2").val("");

                let tabla = $("#ztblPlanillaMovilidad").DataTable();
                tabla.destroy();
                var tr = "";
                $("#ztblPlanillaMovilidadContent").html(tr);
                $("#ztblPlanillaMovilidad").DataTable(
                    {
                        'language': { 'url': '/libs/datatables/spanish.json' },
                        lengthMenu: [[3], [3]]
                    }
                );

                $("#zkpiMontoSeleecionadoModal2").text("0.00");
            }
            else if (tabSeleccion == 3) {

                // 3. Declaración Jurada.
                $("#ztxtCodigoModal3").val("");

                $("#txtCiudadModal3").val("");
                $("#ztxtPaisModal3").val("");

                $("#ztxtFechaDesdeModal3").val(today);
                $("#ztxtFechaHastaModal3").val(today);
                $("#txtMotivoModal3").val("");
                $("#txtImporteModal3").val("");


                let tabla1 = $("#ztblDeclaracionJurada3_1").DataTable();
                tabla1.destroy();
                var tr1 = "";
                $("#ztblDeclaracionJuradaContent3_1").html(tr1);
                $("#ztblDeclaracionJurada3_1").DataTable(
                    {
                        'language': { 'url': '/libs/datatables/spanish.json' },
                        lengthMenu: [[3], [3]]
                    }
                );


                let tabla2 = $("#ztblDeclaracionJurada3_2").DataTable();
                tabla2.destroy();
                var tr2 = "";
                $("#ztblDeclaracionJuradaContent3_2").html(tr2);
                $("#ztblDeclaracionJurada3_2").DataTable(
                    {
                        'language': { 'url': '/libs/datatables/spanish.json' },
                        lengthMenu: [[3], [3]]
                    }
                );


                $("#zkpiMontoSeleecionadoModal3").text("0.00");
            }

            zdetComprobanteArray = [];
        }

        function zactualizarLista(pIdSolicitud) {
            $.ajax({
                url: "/finanzas/RG_SolicitudDetalleRendicion",
                type: "GET",
                data: { idSolicitud: pIdSolicitud },
                dataType: "json",
                success: function (resultado) {

                    if (resultado.isRedirect) {
                        window.location.href = resultado.redirectUrl;
                    }
                    else {
                        zarmarTablaDetalle(resultado.lista);
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {

                }
            });
        }

        function zvalidarEstadoSolicitud(pOpcion, pIdSolicitud) {

            $.ajax({
                url: "/finanzas/RG_ValidarEstadoRendicion",
                type: "POST",
                data: {
                    opcion: pOpcion,
                    idSolicitud: pIdSolicitud,
                    codigo: "",
                    secuencia: 0,
                    idRendCompte: 0
                },
                dataType: "json",
                success: function (resultado) {

                    if (resultado.isRedirect) {
                        window.location.href = resultado.redirectUrl;
                    }
                    else {
                        zindicadorEstado(resultado.status.idResponse);
                        $("#zestado-desc").text(resultado.status.statusResponse);
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {

                }
            });
        }

        function busquedaXDNI(dni, opcionModal) {

            if (dni == "") {
                Swal.fire({
                    title: 'Ingrese el número de DNI',
                    text: "Textile Sourcing Company",
                    icon: 'warning',
                    showConfirmButton: true,
                    showCancelButton: false,
                    confirmButtonText: 'Ok',
                    cancelButtonText: 'Cancel',
                    focusConfirm: true
                }).then(result => {
                    if (result.value) {
                        // Planilla de Movilidad
                        if (opcionModal == 2) {
                            document.getElementById("ztxtDNIModal2").focus = true;
                        }
                        else if (opcionModal == 3) {
                            // Declaracion Jurada
                            document.getElementById("ztxtDNIModal3").focus = true;
                        }
                    }
                });
            }
            else if (dni.length < 7) {
                Swal.fire({
                    title: 'Ingrese un número RUC valido por favor',
                    icon: 'warning',
                    showConfirmButton: true,
                    showCancelButton: false,
                    confirmButtonText: 'Ok',
                    cancelButtonText: 'Cancel',
                    focusConfirm: true
                }).then(result => {
                    if (result.value) {
                        // Planilla de Movilidad
                        if (opcionModal == 2) {
                            document.getElementById("ztxtDNIModal2").focus = true;
                        }
                        else if (opcionModal == 3) {
                            // Declaracion Jurada
                            document.getElementById("ztxtDNIModal3").focus = true;
                        }
                    }
                });
            }
            else {
                $.ajax({
                    type: "GET",
                    url: '/Finanzas/RG_BuscarColaboradorXDNI',
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: { dni: dni },
                    success: function (data) {

                        if (opcionModal == 2) {
                            // Planilla de Movilidad
                            $("#ztxtApeNomModal2").val(data.entidad.codcolaborador + " " + data.entidad.colaborador);
                        }
                        else if (opcionModal == 3) {
                            // Declaracion Jurada
                            $("#ztxtApeNomModal3").val(data.entidad.codcolaborador + " " + data.entidad.colaborador);
                        }

                        if (data.entidad.codcolaborador == "0") {

                            const Toast = Swal.mixin({
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 2500,
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                    toast.addEventListener('mouseenter', Swal.stopTimer)
                                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                                }
                            })

                            Toast.fire({
                                icon: 'warning',
                                title: data.entidad.mensaje
                            });

                            if (opcionModal == 2) {
                                // Planilla de Movilidad
                                document.getElementById("ztxtDNIModal2").focus = true;
                            }
                            else if (opcionModal == 3) {
                                // Declaracion Jurada
                                document.getElementById("ztxtDNIModal3").focus = true;
                            }
                        }
                        else {
                            if (opcionModal == 2) {
                                // Planilla de Movilidad
                                document.getElementById("ztxtOrgDstModal2").focus = true;
                            }
                            else if (opcionModal == 3) {
                                // Declaracion Jurada
                                // document.getElementById("ztxtDNIModal3").focus = true;
                            }
                        }
                    },
                    failure: function () {
                        console.error('error al cargar tipos periodos');
                    }
                });
            }
        }

        function zlistarDetalle(idRendCompte) {

            $.ajax({
                url: "/finanzas/RG_RendicionDetalle",
                type: "GET",
                data: { idRendCompte: idRendCompte },
                dataType: "json",
                success: function (resultado) {

                    if (resultado.isRedirect) {
                        window.location.href = resultado.redirectUrl;
                    }
                    else {
                        let tabla = $("#ztblPlanillaMovilidad").DataTable();

                        tabla.destroy();
                        var tr = "";

                        resultado.lista.forEach((obj) => {

                            tr += "<tr> "
                                + " <td> " + obj.fecha + "</td>"
                                + " <td> " + obj.detalle1 + "</td>"
                                + " <td> " + obj.detalle2 + "</td>"
                                + " <td> " + formatoNumero(obj.importe) + "</td>"
                                + " <td class='text-center'>"
                                + "     <button data-idRendCompteDet='" + obj.idRendCompteDet + "' data-toggle='collapse' class='btn btn-sm btn-danger cselectEliminar ml-1'><i class='fas fa-trash'></i></button>"
                                + "</td>"
                                + "</tr>";
                        });

                        $("#ztblPlanillaMovilidadContent").html(tr);


                        $("#ztblPlanillaMovilidad").DataTable(
                            {
                                dom: 'Bfrtip',
                                "scrollX": true,
                                "bSort": true,
                                buttons: [
                                    'excel', 'pdf', 'print'
                                ],
                                scrollY: '50vh',
                                scrollCollapse: true,
                                paging: true,
                                'language': { 'url': '/libs/datatables/spanish.json' },
                                lengthMenu: [[5, 10, 20, -1], [5, 10, 20, 'Todos']]
                            });
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {

                }
            });


        }

        function zindicadorEstado(idEstado) {

            if (idEstado == 20) {
                // Aprobado
                $("#zestado-icon").removeClass("icon-pendiente");
                $("#zestado-icon").removeClass("icon-liberado");
                $("#zestado-icon").removeClass("icon-rechazado");
                $("#zestado-icon").removeClass("icon-rend-completa");
                $("#zestado-icon").removeClass("icon-rend-incompleta");
                $("#zestado-icon").addClass("icon-aprobado");

                $("#zestado-desc").removeClass("desc-est-pendiente");
                $("#zestado-desc").removeClass("desc-est-liberado");
                $("#zestado-desc").removeClass("desc-est-rechazado");
                $("#zestado-desc").removeClass("desc-est-rend-completa");
                $("#zestado-desc").removeClass("desc-est-rend-incompleta");
                $("#zestado-desc").addClass("desc-est-aprobado");

            }
            else if (idEstado == 26) {
                // Rendicion Incompleta
                $("#zestado-icon").removeClass("icon-pendiente");
                $("#zestado-icon").removeClass("icon-liberado");
                $("#zestado-icon").removeClass("icon-rechazado");
                $("#zestado-icon").removeClass("icon-rend-completa");
                $("#zestado-icon").addClass("icon-rend-incompleta");

                $("#zestado-desc").removeClass("desc-est-pendiente");
                $("#zestado-desc").removeClass("desc-est-liberado");
                $("#zestado-desc").removeClass("desc-est-rechazado");
                $("#zestado-desc").removeClass("desc-est-rend-completa");
                $("#zestado-desc").addClass("desc-est-rend-incompleta");

            }
            else if (idEstado == 21) {
                // Rendicion Completa
                $("#estado-ico  n").removeClass("icon-pendiente");
                $("#zestado-icon").removeClass("icon-liberado");
                $("#zestado-icon").removeClass("icon-rechazado");
                $("#zestado-icon").removeClass("icon-rend-incompleta");
                $("#zestado-icon").addClass("icon-rend-completa");

                $("#zestado-desc").removeClass("desc-est-pendiente");
                $("#zestado-desc").removeClass("desc-est-liberado");
                $("#zestado-desc").removeClass("desc-est-rechazado");
                $("#zestado-desc").removeClass("desc-est-rend-incompleta");
                $("#zestado-desc").addClass("desc-est-rend-completa");
            }
        }

        function formatoNumero(x) {
            x = x.toFixed(2);
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function zarmarTablaDetalle(lista) {

            let tabla = $("#ztblSolicitud").DataTable();

            tabla.destroy();
            var tr = "";
            let tr_btn_pdf = "";
            let tr_fin = "";
            let tr_cptes = "";


            lista.forEach((obj) => {

                tr += "<tr> "
                    + " <td class='ocultar-columna'>" + obj.idSolicitud + "</td>"
                    + " <td class='ocultar-columna'> " + obj.secuencia + "</td>";

                if (obj.countCpte == 0) {
                    tr_cptes = " <td class='text-center'>"
                        + "     <button data-idtipocomp = " + obj.idTipoComp + " data-idsolicitud='" + obj.idSolicitud + "' data-secuencia='" + obj.secuencia + "'  data-valor=" + obj.valor + " data-totalsolicitado = " + obj.totalSolicitado + " data-restante=" + (obj.totalSolicitado - obj.totalRendido) + " data-idconceptodet=" + obj.idConceptoDet + " data-toggle='collapse' class='btn btn-sm btn-info cDetalleComprobante'>0 <i class='fas fa-eye'></i></button>"
                        + "</td>";
                }
                else if (obj.countCpte == 1) {
                    tr_cptes = " <td class='text-center'>"
                        + "     <button data-idtipocomp = " + obj.idTipoComp + " data-idsolicitud='" + obj.idSolicitud + "' data-secuencia='" + obj.secuencia + "'  data-valor=" + obj.valor + " data-totalsolicitado = " + obj.totalSolicitado + " data-restante=" + (obj.totalSolicitado - obj.totalRendido) + " data-idconceptodet=" + obj.idConceptoDet + " data-toggle='collapse' class='btn btn-sm btn-info cDetalleComprobante'>" + obj.serieNumero + " <i class='fas fa-eye'></i></button>"
                        + "</td>";
                }
                else {
                    tr_cptes = " <td class='text-center'>"
                        + "     <button data-idtipocomp = " + obj.idTipoComp + " data-idsolicitud='" + obj.idSolicitud + "' data-secuencia='" + obj.secuencia + "'  data-valor=" + obj.valor + " data-totalsolicitado = " + obj.totalSolicitado + " data-restante=" + (obj.totalSolicitado - obj.totalRendido) + " data-idconceptodet=" + obj.idConceptoDet + " data-toggle='collapse' class='btn btn-sm btn-info cDetalleComprobante'>2+ <i class='fas fa-eye'></i></button>"
                        + "</td>";

                }

                tr = tr + tr_cptes;


                tr = tr + " <td> " + obj.tipo + "</td>"
                    + " <td> " + obj.conceptoCab + "</td>"
                    + " <td> " + obj.conceptoDet + "</td>"
                    + " <td> " + obj.cantDias + "</td>"
                    + " <td> " + formatoNumero(obj.valor) + "</td>"
                    + " <td> " + obj.simbolo + " " + formatoNumero(obj.totalSolicitado) + "</td>"
                    + " <td> " + obj.simbolo + " " + formatoNumero(obj.totalEntregado) + "</td>"
                    + " <td> " + obj.simbolo + " " + formatoNumero(obj.totalRendido) + "</td>"
                    + " <td> " + obj.simbolo + " " + formatoNumero(obj.totalSolicitado - obj.totalRendido) + "</td>"

                    //+ " <td class='text-center'>"
                    //+ "     <button data-idrendcompte=" + obj.idRendCompte + "  data-idsolicitud='" + obj.idSolicitud + "' data-secuencia='" + obj.secuencia + "'  data-valor=" + obj.valor + " data-totalsolicitado = " + obj.totalSolicitado + " data-restante=" + (obj.totalSolicitado - obj.totalRendido) + " data-idconceptodet=" + obj.idConceptoDet + " data-toggle='collapse' class='btn btn-sm btn-success cEditarCpte' " + ((obj.idRendCompte > 0) ? "  " : " disabled ") + "><i class='fas fa-edit'></i></button>"
                    //+ "</td>"

                //tr = tr + tr_fin;


                //if (obj.idTipoComp == 3 || obj.idTipoComp == 4) {
                //    tr_btn_pdf =
                //          " <td class='text-center'>"
                //        + "     <button data-idtipocomp = " + obj.idTipoComp + " data-idrendcompte=" + obj.idRendCompte + " data-toggle='collapse' class='btn btn-sm btn-danger cImprimirPDF' " + (obj.idRendCompte == 0 ? " disabled " : " ") + "><i class='fas fa-file-pdf'></i></button>"
                //        + " </td> ";
                //}
                //else {
                //    tr_btn_pdf = " <td class='text-center'></td> ";
                //}

                //tr = tr + tr_btn_pdf;

                    // OLD
                    //+ " <td class='text-center'>"
                    //+ "     <input type='checkbox' data-idsolicitud='" + obj.idSolicitud + "' data-secuencia='" + obj.secuencia + "' data-valor=" + obj.valor + " data-restante=" + (obj.totalSolicitado - obj.totalRendido) + " class='seleccion ml-2' " + (obj.idEstadoDet == 6 ? " disabled " : " ") + ">"
                    //+ "</td>"

                    + " <td class='text-center'>"
                    + "     <button data-idsolicitud = " + obj.idSolicitud + " data-secuencia = " + obj.secuencia + " data-idtipocomp = " + obj.idTipoComp + " data-idrendcompte=" + obj.idRendCompte + "  data-valor=" + obj.valor + " data-restante=" + (obj.totalSolicitado - obj.totalRendido) + " data-idconceptodet=" + obj.idConceptoDet + " data-toggle='collapse' class='btn btn-sm btn-primary cRegistrarCpte'><i class='fas fa-save'></i></button>"
                    + "</td>"
                    + "</tr>";

                //tr = tr + tr_fin;


            });


            $("#ztblSolicitudContent").html(tr);

            $("#ztblSolicitud").DataTable(
                {
                    "scrollX": true,
                    "bSort": true,
                    buttons: [
                        'excel', 'pdf', 'print'
                    ],
                    scrollY: '50vh',
                    scrollCollapse: true,
                    paging: true,
                    'language': { 'url': '/libs/datatables/spanish.json' },
                    lengthMenu: [[5, 10, 20, -1], [5, 10, 20, 'Todos']]
                });
        }


        $("#zbtnVerRegistrados").click(function () {

            if (zvalidacionVerCmptes()) {

                $.ajax({
                    url: "@Url.Action("RG_BuscarIdSolicitud", "Finanzas")",
                    data: {
                        idSolicitud: zsolicitudSeleccionada.idSolicitud,
                    },
                    success: function (data) {
                        window.location.href = '@Url.Action("MapearReporteCXSPDF", "Finanzas")'
                    }
                });



                //$.ajax({
                //    url: "/finanzas/RG_ComprobantesRegistrados",
                //    type: "GET",
                //    data: { idSolicitud: zsolicitudSeleccionada.idSolicitud },
                //    dataType: "json",
                //    success: function (resultado) {

                //        console.log("ver Registrados");
                //        console.log(resultado);

                //        if (resultado.isRedirect) {
                //            window.location.href = resultado.redirectUrl;
                //        }
                //        else {
                //            let itemList = "";
                //            let activoPrimero = true;
                //            let comprobanteCab = 0;

                //            $("#zlist-comprobantes").empty();

                //            resultado.lista.forEach((obj) => {
                //                itemList += "<a class='list-group-item list-group-item-action " + (activoPrimero ? " active " : " ") + "' data-toggle='list' role='tab' data-idrendcompte=" + obj.idRendCompte + ">" + obj.serieNumero + "</a>";

                //                if (activoPrimero) {
                //                    comprobanteCab = obj;
                //                }

                //                activoPrimero = false;
                //            });

                //            $("#zlist-comprobantes").html(itemList);

                //            zcargarComprobanteCabecera(comprobanteCab.idRendCompte);

                //            $("#editComprobModal").modal("show");
                //        }
                //    },
                //    error: function (xhr, ajaxOptions, thrownError) {

                //    }
                //});
            }
        });

        function zvalidacionVerCmptes() {
            var respuesta = false;

            let idSolicitud = zsolicitudSeleccionada.idSolicitud;

            if (idSolicitud == null || typeof (idSolicitud) == "undefined") {
                respuesta = false;

                Swal.fire({
                    title: 'Seleccione una Solicitud por favor',
                    text: "Textile Sourcing Company",
                    icon: 'warning',
                    showConfirmButton: true,
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'Ok'
                });
            }
            else {
                respuesta = true;
            }

            return respuesta;
        }

        $("#zlist-comprobantes").on("click", "a", function () {

            let idRendCompte = $(this).attr("data-idrendcompte");

            zcargarComprobanteCabecera(idRendCompte);
        });


        function zgetSolicitudComprobante(idRendCompte) {

            $.ajax({
                url: "/finanzas/RG_SolicitudComprobante",
                type: "GET",
                data: { idRendCompte: idRendCompte },
                dataType: "json",
                success: function (resultado) {
                    zdetalleArray = resultado.lista;
                },
                error: function (xhr, ajaxOptions, thrownError) {

                }
            });
        }


        function zcargarComprobanteCabecera(pIdRendCompte) {

            $.ajax({
                url: "/finanzas/RG_ComprobateCabecera",
                type: "GET",
                data: { idRendCompte: pIdRendCompte },
                dataType: "json",
                success: function (resultado) {

                    if (resultado.isRedirect) {
                        window.location.href = resultado.redirectUrl;
                    }
                    else {

                        zlistaComptesIdTipoComp = resultado.entidad.idTipoComp;

                        if (resultado.entidad.idTipoComp == 1 || resultado.entidad.idTipoComp == 2) {

                            // FACTURA Y BOLETA
                            $("#zfacturaboleta-tab").removeClass("disabled");
                            $("#zplanillamovilidad-tab").addClass("disabled");
                            $("#zdeclaracionjur-tab").addClass("disabled");

                            $("#zregComprobModal .nav-tabs #zfacturaboleta-tab").tab('show');
                            ztabSeleccionado = 1;

                            $("#zcbxTipoCpbteCompModal1").val(resultado.entidad.idTipoComp);
                            document.getElementById("zcbxTipoCpbteCompModal1").disabled = true;

                            //$("#txtSerieNumCompModal1").val(resultado.entidad.serieNumero);
                            $("#ztxtSerieModal1").val(resultado.entidad.nserie);
                            $("#ztxtNumeroModal1").val($.trim(resultado.entidad.ndocof));

                            $("#ztxtFechaModal1").val(resultado.entidad.fechaEmision);
                            $("#zcbxMonedaModal1").val(resultado.entidad.idTipoMod);
                            $("#zcbxPeriodoModal1").val(resultado.entidad.periodo);
                            $("#ztxtRucCompModal1").val(resultado.entidad.rucDNI);
                            $("#ztxtRSCompModal1").val(resultado.entidad.rs);
                            $("#ztxtCodSofyaPCModal1").val(resultado.entidad.codigoPC);
                            $("#ztxtObsCompModal1").val(resultado.entidad.obs);
                            $("#ztxtCeCoModal1").val(resultado.entidad.ceco);

                            $("#zkpiMontoSeleecionadoModal1").text(resultado.entidad.simbolo + " " + formatoNumero(resultado.entidad.totalCmpbnteSolicitud - resultado.entidad.totalCmpbnte));


                            if (resultado.entidad.idTipoComp == 1) {
                                // Factura
                                $("#zidimportetotal1").val(formatoNumero(resultado.entidad.totalCmpbnteBI));
                                $("#zidigv1").val(formatoNumero(resultado.entidad.totalCmpbnteBI * (PORCENTAJE_IGV / 100)));
                                $("#zidtotal1").val(formatoNumero(resultado.entidad.totalCmpbnte));
                            }
                            else if (resultado.entidad.idTipoComp == 2) {
                                // Boleta
                                $("#zidimportetotal1").val(formatoNumero(resultado.entidad.totalCmpbnteBI));
                                $("#zidigv1").val(formatoNumero(0));
                                $("#zidtotal1").val(formatoNumero(resultado.entidad.totalCmpbnte));
                            }

                            $("#zcbxUM1").val("UN");
                            $("#ztxtDescripcion1").val("");
                            $("#ztxtCantidad1").val("");
                            $("#ztxtValorUnitarioTotal1").val("");

                            zdefinirValoresTipoCpte($("#zcbxTipoCpbteCompModal1").val());
                            zcargarComprobanteDetalle(resultado.entidad.idRendCompte, resultado.entidad.idTipoComp);

                        }
                        else if (resultado.entidad.idTipoComp == 3) {

                            // PLANILLA DE MOVILIDADA
                            $("#zfacturaboleta-tab").addClass("disabled");
                            $("#zplanillamovilidad-tab").removeClass("disabled");
                            $("#zdeclaracionjur-tab").addClass("disabled");

                            $('#zregComprobModal .nav-tabs #zplanillamovilidad-tab').tab('show');
                            ztabSeleccionado = 2;

                            $("#ztxtFechaModal2").val(resultado.entidad.fechaEmision);
                            $("#ztxtNumPlanillaModal2").val(resultado.entidad.serieNumero);
                            $("#zcbxMonedaModal2").val(resultado.entidad.idTipoMod);
                            $("#zcbxPeriodoModal2").val(resultado.entidad.periodo);
                            $("#ztxtDNIModal2").val(resultado.entidad.rucDNI);
                            $("#ztxtApeNomModal2").val(resultado.entidad.rs);
                            $("#ztxtCeCoModal2").val(resultado.entidad.ceco);

                            $("#zkpiMontoSeleecionadoModal2").text(resultado.entidad.simbolo + " " + formatoNumero(resultado.entidad.totalCmpbnteSolicitud - resultado.entidad.totalCmpbnte));

                            zcargarComprobanteDetalle(resultado.entidad.idRendCompte, resultado.entidad.idTipoComp);
                        }
                        else if (resultado.entidad.idTipoComp == 4) {

                            // DECLARACION JURADA.
                            $("#zfacturaboleta-tab").addClass("disabled");
                            $("#zplanillamovilidad-tab").addClass("disabled");
                            $("#zdeclaracionjur-tab").removeClass("disabled");

                            $('#zregComprobModal .nav-tabs #zdeclaracionjur-tab').tab('show');
                            ztabSeleccionado = 3;

                            $("#ztxtFechaModal3").val(resultado.entidad.fechaEmision);
                            $("#ztxtCodigoModal3").val(resultado.entidad.serieNumero);
                            $("#zcbxMonedaModal3").val(resultado.entidad.idTipoMod);
                            $("#zcbxPeriodoModal3").val(resultado.entidad.periodo);
                            $("#ztxtDNIModal3").val(resultado.entidad.rucDNI);
                            $("#ztxtApeNomModal3").val(resultado.entidad.rs);
                            $("#ztxtCeCoModal3").val(resultado.entidad.ceco);

                            $("#zkpiMontoSeleecionadoModal3").text(resultado.entidad.simbolo + " " + formatoNumero(resultado.entidad.totalCmpbnteSolicitud - resultado.entidad.totalCmpbnte));

                            zcargarComprobanteDetalle(resultado.entidad.idRendCompte, resultado.entidad.idTipoComp);
                        }





                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {

                }
            });

        }

        function zcargarComprobanteDetalle(pIdRendCompte, pIdTipoComp) {

            $.ajax({
                url: "/finanzas/RG_ComprobateDetalle",
                type: "GET",
                data: { idRendCompte: pIdRendCompte },
                dataType: "json",
                success: function (resultado) {

                    if (resultado.isRedirect) {
                        window.location.href = resultado.redirectUrl;
                    }
                    else {

                        if (pIdTipoComp == 1 || pIdTipoComp == 2) {

                            // FACTURA Y BOLETA

                            let tablaFB = $("#ztblFacturaBoleta").DataTable();

                            tablaFB.destroy();
                            var trFB = "";
                            zdetComprobanteArray1 = [];

                            resultado.lista.forEach((obj) => {

                                ziDetalle1++;

                                zdetComprobanteArray1.push({
                                    iDetalle: ziDetalle1,
                                    fecha: obj.fecha,
                                    fechaBD: obj.fechaBD,
                                    detalle1: obj.detalle1,
                                    detalle2: "",
                                    codum: obj.codum,
                                    valorunit: obj.valorunit,
                                    cantidad: obj.cantidad,
                                    total: obj.total
                                });

                                trFB += "<tr> "
                                    + " <td> " + obj.um + "</td>"
                                    + " <td> " + obj.detalle1 + "</td>"
                                    + " <td> " + obj.cantidad + "</td>"
                                    + " <td> " + formatoNumero(obj.valorunit) + "</td>"
                                    + " <td> " + formatoNumero(obj.total) + "</td>"
                                    + " <td class='text-center'>"
                                    + "     <button data-idetalle ='" + ziDetalle1 + "' class='btn btn-sm btn-danger cselectEliminar1 ml-1'><i class='fas fa-trash'></i></button>"
                                    + "</td>"
                                    + "</tr>";
                            });


                            $("#ztblFacturaBoletaContent").html(trFB);

                            $("#ztblFacturaBoleta").DataTable(
                                {
                                    'language': { 'url': '/libs/datatables/spanish.json' },
                                    lengthMenu: [[3], [3]]
                                });

                        }
                        else if (pIdTipoComp == 3) {

                            // PLANILLA DE MOVILIDAD

                            let tablaPM = $("#ztblPlanillaMovilidad").DataTable();

                            tablaPM.destroy();
                            var trPM = "";
                            zdetComprobanteArray2 = [];

                            resultado.lista.forEach((obj) => {

                                ziDetalle2++;

                                zdetComprobanteArray2.push({
                                    iDetalle: ziDetalle2,
                                    fecha: obj.fecha,
                                    fechaBD: obj.fechaBD,
                                    detalle1: obj.detalle1,
                                    detalle2: obj.detalle2,
                                    codum: obj.codum, // UNIDAD
                                    valorunit: obj.valorunit,
                                    cantidad: obj.cantidad
                                });

                                trPM += "<tr> "
                                    + " <td> " + obj.fecha + "</td>"
                                    + " <td> " + obj.detalle1 + "</td>"
                                    + " <td> " + obj.detalle2 + "</td>"
                                    + " <td> " + formatoNumero(obj.valorunit) + "</td>"
                                    + " <td class='text-center'>"
                                    + "     <button data-idetalle='" + ziDetalle2 + "' data-toggle='collapse' class='btn btn-sm btn-danger cselectEliminar2 ml-1'><i class='fas fa-trash'></i></button>"
                                    + "</td>"
                                    + "</tr>";
                            });

                            $("#ztblPlanillaMovilidadContent").html(trPM);

                            $("#ztblPlanillaMovilidad").DataTable(
                                {
                                    'language': { 'url': '/libs/datatables/spanish.json' },
                                    lengthMenu: [[3], [3]]
                                });

                        }
                        else if (pIdTipoComp == 4) {

                            // DECLARACION JURADA

                            let tablaDJ_1 = $("#ztblDeclaracionJurada3_1").DataTable();
                            let tablaDJ_2 = $("#ztblDeclaracionJurada3_2").DataTable();

                            tablaDJ_1.destroy();
                            tablaDJ_2.destroy();

                            var trDJ_1 = "";
                            var trDJ_2 = "";

                            zdetComprobanteArray3 = [];


                            resultado.lista.forEach((obj) => {

                                ziDetalle3++;

                                zdetComprobanteArray3.push({
                                    iDetalle: ziDetalle3,
                                    fecha: obj.fecha,
                                    fechaBD: obj.fechaBD,
                                    detalle1: obj.detalle1,
                                    detalle2: "",
                                    codum: obj.codum, // UNIDAD
                                    valorunit: obj.valorunit,
                                    cantidad: obj.cantidad,
                                    seccion: obj.seccion
                                });

                                if (obj.seccion == 1) {
                                    trDJ_1 += "<tr> "
                                        + " <td> " + obj.fecha + "</td>"
                                        + " <td> " + obj.detalle1 + "</td>"
                                        + " <td> " + formatoNumero(obj.valorunit) + "</td>"
                                        + " <td class='text-center'>"
                                        + "     <button data-idetalle='" + ziDetalle3 + "' data-toggle='collapse' class='btn btn-sm btn-danger cselectEliminar3_1 ml-1'><i class='fas fa-trash'></i></button>"
                                        + "</td>"
                                        + "</tr>";
                                }
                                else if (obj.seccion == 2) {
                                    trDJ_2 += "<tr> "
                                        + " <td> " + obj.fecha + "</td>"
                                        + " <td> " + obj.detalle1 + "</td>"
                                        + " <td> " + formatoNumero(obj.valorunit) + "</td>"
                                        + " <td class='text-center'>"
                                        + "     <button data-idetalle='" + ziDetalle3 + "' data-toggle='collapse' class='btn btn-sm btn-danger cselectEliminar3_2 ml-1'><i class='fas fa-trash'></i></button>"
                                        + "</td>"
                                        + "</tr>";
                                }

                            });

                            $("#ztblDeclaracionJuradaContent3_1").html(trDJ_1);
                            $("#ztblDeclaracionJuradaContent3_2").html(trDJ_2);

                            $("#ztblDeclaracionJurada3_1").DataTable(
                                {
                                    'language': { 'url': '/libs/datatables/spanish.json' },
                                    lengthMenu: [[5], [5]]
                                });

                            $("#ztblDeclaracionJurada3_2").DataTable(
                                {
                                    'language': { 'url': '/libs/datatables/spanish.json' },
                                    lengthMenu: [[5], [5]]
                                });
                        }
                    }

                },
                error: function (xhr, ajaxOptions, thrownError) {

                }
            });
        }

        function zmensajePrincipal(estado, mensaje) {
            if (estado == true) {

                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2500,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                })

                Toast.fire({
                    icon: 'success',
                    title: mensaje
                });

            }
            else if (estado == false) {

                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2500,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                })

                Toast.fire({
                    icon: 'error',
                    title: mensaje
                });

            }
        }

        $("#ztblCptesRegistradosCont").on("click", ".cImprimirPDF", function () {

            let idTipoComp = $(this).attr("data-idtipocomp");
            let idRendCompte = $(this).attr("data-idrendcompte");

            $.ajax({
                url: "@Url.Action("RG_BuscarIdCompte", "Finanzas")",
                data: {
                    idTipoComp: idTipoComp,
                    idRendCompte: idRendCompte
                },
                success: function (data) {

                    if (idTipoComp == 3) {
                        // Planilla de Movilidad
                        window.location.href = '@Url.Action("MapearReportePLPDF", "Finanzas")'
                    }
                    else if (idTipoComp == 4) {
                        // Declaración Jurada
                        window.location.href = '@Url.Action("MapearReporteDJPDF", "Finanzas")'
                    }

                }
            });

        });

        $("#ztblSolicitudContent").on("click", ".cDevolucion", function () {

            zidsolicitud_dev = $(this).attr("data-idsolicitud");
            zidsecuencia_dev = $(this).attr("data-secuencia");


            $("#zregistrarDevModal").modal("show");

        });

        $("#ztblCptesRegistradosCont").on("click", ".cEditarCpte", function () {

            $("#zdetComprobantesModal").modal("hide");
            zdetalleArray = []; // jjjj

            let idsolicitud = $(this).attr("data-idsolicitud");
            let secuencia = $(this).attr("data-secuencia");
            let valor = $(this).attr("data-valor");
            let totalRestante = $(this).attr("data-restante");
            let totalsolicitado = $(this).attr("data-totalsolicitado");

            zvIdRendCompte = $(this).attr("data-idrendcompte");

            zdetalleArray.push({ idsolicitud: idsolicitud, secuencia: secuencia, valor: parseFloat(valor), totalrestante: parseFloat(totalsolicitado) });

            zTIPO_REGISTRO = "EDITAR";

            zcargarComprobanteCabecera(zvIdRendCompte);

            $("#zregComprobModal").modal("show");
        });


        $("#ztblSolicitudContent").on("click", ".cDetalleComprobante", function () {

            let idsolicitud = $(this).attr("data-idsolicitud");
            let secuencia = $(this).attr("data-secuencia");

            let v_valor = $(this).attr("data-valor");
            let v_totalsolicitado = $(this).attr("data-totalsolicitado");
            let v_restante = $(this).attr("data-restante");
            let v_idconceptodet = $(this).attr("data-idconceptodet");
            let v_idtipo = $(this).attr("data-idtipocomp");


            $.ajax({
                type: "GET",
                url: '/finanzas/RG_CptesRegistrados',
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: {
                    'idsolicitud': idsolicitud,
                    'secuencia': secuencia
                },
                success: function (data) {

                    let tabla = $("#ztblCptesRegistrados").DataTable();

                    tabla.destroy();
                    var tr = "";
                    var tr_btn_pdf = "";


                    data.lista.forEach((obj) => {

                        tr += "<tr> "
                            + " <td> " + obj.numserie + "</td>"
                            + " <td> " + obj.rs + "</td>"
                            + " <td> " + obj.simbolo + " " + formatoNumero(obj.total) + "</td>";


                        if (v_idtipo == 3 || v_idtipo == 4) {
                            tr_btn_pdf =
                                " <td class='text-center'>"
                            + "     <button data-idtipocomp = " + v_idtipo + " data-idrendcompte=" + obj.idRendCompte + " data-toggle='collapse' class='btn btn-sm btn-danger cImprimirPDF' " + (obj.idRendCompte == 0 ? " disabled " : " ") + "><i class='fas fa-file-pdf'></i></button>"
                                + " </td> ";
                        }
                        else {
                            tr_btn_pdf = " <td class='text-center'></td> ";
                        }

                        tr = tr + tr_btn_pdf;


                        tr = tr + " <td class='text-center'>"
                                + "     <button data-idrendcompte=" + obj.idRendCompte + "  data-idsolicitud='" + idsolicitud + "' data-secuencia='" + secuencia + "'  data-valor=" + v_valor + " data-totalsolicitado = " + v_totalsolicitado + " data-restante=" + v_restante + " data-idconceptodet=" + v_idconceptodet + " data-toggle='collapse' class='btn btn-sm btn-success cEditarCpte'><i class='fas fa-edit'></i></button>"
                                + "</td>"

                                + " <td class='text-center'>"
                                + "     <button data-idrendcompte=" + obj.idRendCompte + " class='btn btn-sm btn-danger cEliminarCpte'><i class='fas fa-trash'></i></button>"
                                + "</td>"

                                + "</tr>";
                    });

                    $("#ztblCptesRegistradosCont").html(tr);

                    $("#ztblCptesRegistrados").DataTable(
                        {
                            searching: false,
                            paging: false,
                            info: false,
                            'language': { 'url': '/libs/datatables/spanish.json' }
                        });


                    $("#zdetComprobantesModal").modal("show");

                },
                failure: function () {
                    console.error('error al cargar los periodos');
                }
            });

        });



        $("#ztblCptesRegistradosCont").on("click", ".cEliminarCpte", function () {

            let idRendCompte = $(this).attr("data-idrendcompte");

            if (idRendCompte == "0" || idRendCompte == null || typeof (idRendCompte) == "undefined") {

                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2500,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                })

                Toast.fire({
                    icon: 'warning',
                    title: 'No existe comprobante para eliminar'
                });
            }
            else {

                Swal.fire({
                    title: '¿Desea Eliminar el Comprobante?',
                    text:'Textile Sourcing Company',
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    cancelButtonText: 'Cancelar',
                    confirmButtonText: 'Ok'

                }).then((result) => {

                    if (result.value) {

                        parametro = {
                            'opcion': 10,
                            'idRendCompte': idRendCompte,
                            'idTipoComp': 0,
                            'serieNumero': "",
                            'rucDNI': "",
                            'rs': "",
                            'codigoPC': "",
                            'obs': "",
                            'fechaEmision': "",
                            'codceco': 0,
                            'idTipoMod': 0,
                            'porcentajeIGV': 0,
                            'obs1': '',
                            'obs2': '',
                            'fecha1': '',
                            'periodo': "",
                            'solitudSeqArray': null,
                            'detalleComprobanteArray': null,
                            'idSolicitud': 0,
                            'secuencia': 0
                        };

                        $.ajax({
                            url: "/finanzas/RG_SetRendicionComprobante",
                            type: "post",
                            data: parametro,
                            dataType: "json",
                            success: function (resultado) {

                                if (resultado.isRedirect) {
                                    window.location.href = resultado.redirectUrl;
                                }
                                else {
                                    if (resultado.entidad.idResponse > 0) {

                                        zvalidarEstadoSolicitud(2, zsolicitudSeleccionada.idSolicitud);
                                        zactualizarLista(zsolicitudSeleccionada.idSolicitud);

                                        zmensajePrincipal(true, resultado.entidad.statusResponse);
                                    }
                                    else {
                                        zmensajePrincipal(false, resultado.entidad.statusResponse);
                                    }


                                    $("#zdetComprobantesModal").modal("hide");
                                }
                            },
                            error: function (xhr, ajaxOptions, thrownError) {

                            }
                        });

                    }

                });
            }
        });


        $('#ztxtMontoDevolucion').keypress(function (event) {
            var keycode = (event.keyCode ? event.keyCode : event.which);

            if (keycode == '13') {

                let monto = $("#ztxtMontoDevolucion").val().trim();

                if (monto == "") {
                    Swal.fire({
                        title: 'Ingrese el monto por favor',
                        text: "Textile Sourcing Company",
                        icon: 'warning',
                        showConfirmButton: true,
                        showCancelButton: false,
                        confirmButtonText: 'Ok',
                        cancelButtonText: 'Cancel',
                        focusConfirm: true
                    }).then(result => {
                        if (result.value) {
                            document.getElementById("ztxtMontoDevolucion").focus = true;
                        }
                    });
                }
                else if (parseFloat(monto) <= 0 || parseFloat(monto) > 1000) {
                    Swal.fire({
                        title: 'Ingrese un monto correcto, por favor',
                        icon: 'warning',
                        showConfirmButton: true,
                        showCancelButton: false,
                        confirmButtonText: 'Ok',
                        cancelButtonText: 'Cancel',
                        focusConfirm: true
                    }).then(result => {
                        if (result.value) {
                            document.getElementById("ztxtMontoDevolucion").focus = true;
                        }
                    });
                }
                else {

                    MostrarCarga("Guardando...");


                    $.ajax({
                        url: "/finanzas/RG_SetDevolucionRend",
                        type: "POST",
                        data: {
                            'opcion': 5,
                            'idsolicitud': zidsolicitud_dev,
                            'secuencia': zidsecuencia_dev,
                            'montoDev': parseFloat(monto)
                        },
                        dataType: "json",
                        success: function (resultado) {

                            if (resultado.isRedirect) {
                                window.location.href = resultado.redirectUrl;
                            }
                            else {

                                if (resultado.entidad.idResponse > 0) {

                                    Swal.fire({
                                        title: 'Registro Correcto',
                                        text: 'Textile Sourcing CompanY',
                                        icon: 'success',
                                        showConfirmButton: true,
                                        showCancelButton: false,
                                        confirmButtonText: 'Ok',
                                        cancelButtonText: 'Cancel',
                                        focusConfirm: true
                                    }).then(result => {
                                        if (result.value) {
                                            document.getElementById("ztxtMontoDevolucion").focus = true;
                                        }
                                    });
                                }
                                else {

                                    Swal.fire({
                                        title: 'Ocurrio un error al registrar monto',
                                        text: 'Textile Sourcing CompanY',
                                        icon: 'error',
                                        showConfirmButton: true,
                                        showCancelButton: false,
                                        confirmButtonText: 'Ok',
                                        cancelButtonText: 'Cancel',
                                        focusConfirm: true
                                    }).then(result => {
                                        if (result.value) {
                                            document.getElementById("ztxtMontoDevolucion").focus = true;
                                        }
                                    });

                                }

                                $("#zregistrarDevModal").modal("hide");
                            }
                        },
                        error: function (xhr, ajaxOptions, thrownError) {

                        }
                    });

                }

            }
        });

        $('#zregistrarDevModal').on('shown.bs.modal', function (e) {
            document.getElementById("ztxtMontoDevolucion").focus = true;
        });

        $('#zregistrarDevModal').on('hidden.bs.modal', function (e) {
            $("#ztxtMontoDevolucion").val("");
        });

        $("#zbtnGuardarDevolucion").click(function () {

            let monto = $("#ztxtMontoDevolucion").val().trim();

            if (monto == "") {
                Swal.fire({
                    title: 'Ingrese el monto por favor',
                    text: "Textile Sourcing Company",
                    icon: 'warning',
                    showConfirmButton: true,
                    showCancelButton: false,
                    confirmButtonText: 'Ok',
                    cancelButtonText: 'Cancel',
                    focusConfirm: true
                }).then(result => {
                    if (result.value) {
                        document.getElementById("ztxtMontoDevolucion").focus = true;
                    }
                });
            }
            else if (parseFloat(monto) <= 0 || parseFloat(monto) > 1000) {
                Swal.fire({
                    title: 'Ingrese un monto correcto, por favor',
                    icon: 'warning',
                    showConfirmButton: true,
                    showCancelButton: false,
                    confirmButtonText: 'Ok',
                    cancelButtonText: 'Cancel',
                    focusConfirm: true
                }).then(result => {
                    if (result.value) {
                        document.getElementById("ztxtMontoDevolucion").focus = true;
                    }
                });
            }
            else {

                MostrarCarga("Guardando...");


                $.ajax({
                    url: "/finanzas/RG_SetDevolucionRend",
                    type: "POST",
                    data: {
                        'opcion': 5,
                        'idsolicitud': zidsolicitud_dev,
                        'secuencia': zidsecuencia_dev,
                        'monto': parseFloat(monto)
                    },
                    dataType: "json",
                    success: function (resultado) {

                        if (resultado.isRedirect) {
                            window.location.href = resultado.redirectUrl;
                        }
                        else {

                            if (resultado.entidad.idResponse > 0) {

                                Swal.fire({
                                    title: 'Registro Correcto',
                                    text: 'Textile Sourcing CompanY',
                                    icon: 'success',
                                    showConfirmButton: true,
                                    showCancelButton: false,
                                    confirmButtonText: 'Ok',
                                    cancelButtonText: 'Cancel',
                                    focusConfirm: true
                                }).then(result => {
                                    if (result.value) {
                                        document.getElementById("ztxtMontoDevolucion").focus = true;
                                    }
                                });
                            }
                            else {

                                Swal.fire({
                                    title: 'Ocurrio un error al registrar monto',
                                    text: 'Textile Sourcing CompanY',
                                    icon: 'error',
                                    showConfirmButton: true,
                                    showCancelButton: false,
                                    confirmButtonText: 'Ok',
                                    cancelButtonText: 'Cancel',
                                    focusConfirm: true
                                }).then(result => {
                                    if (result.value) {
                                        document.getElementById("ztxtMontoDevolucion").focus = true;
                                    }
                                });

                            }

                            zactualizarLista(zsolicitudSeleccionada.idSolicitud);
                            $("#zregistrarDevModal").modal("hide");
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {

                    }
                });

            }


        });



    </script>

}

